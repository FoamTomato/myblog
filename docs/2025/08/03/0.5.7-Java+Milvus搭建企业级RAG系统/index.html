<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Java+Milvus搭建企业级RAG系统 | 喵喵鱼塘</title><meta name="author" content="Foam🍅"><meta name="copyright" content="Foam🍅"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="随着大语言模型的快速发展，企业希望将其应用于内部知识库问答系统。RAG（Retrieval Augmented Generation）技术通过结合向量检索和生成式AI，为企业提供精准、实时的知识问答能力。本文将详细介绍如何使用Java+Milvus搭建一套企业级的RAG系统。  引言为什么需要企业"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://foamtomato.github.io/2025/08/03/0.5.7-Java+Milvus%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7RAG%E7%B3%BB%E7%BB%9F/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Java+Milvus搭建企业级RAG系统',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-29 18:13:30'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/static-butterfly/dist/css/index.min.css"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"><style>
/* 修复JetBrains Mono字体引用 */
@font-face {
  font-family: 'MyFont';
  src: url('https://cdn.jsdelivr.net/gh/JetBrains/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2') format('woff2'),
       url('https://cdn.jsdelivr.net/gh/JetBrains/JetBrainsMono/web/woff/JetBrainsMono-Regular.woff') format('woff');
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}
</style>
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/hexo-electric-clock@1.0.6/clock.css"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/favicon.ico" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">57</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 鱼塘</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 喵生</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 关键词</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 猫片</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 猫の友</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 语录</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://images.unsplash.com/photo-1677442136019-21780ecad995?w=1200&amp;h=400&amp;fit=crop')"><nav id="nav"><span id="blog-info"><a href="/" title="喵喵鱼塘"><span class="site-name">喵喵鱼塘</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 鱼塘</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 喵生</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 关键词</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 猫片</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 猫の友</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 语录</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Java+Milvus搭建企业级RAG系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-03T07:56:49.000Z" title="发表于 2025-08-03 15:56:49">2025-08-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-29T10:13:30.585Z" title="更新于 2025-08-29 18:13:30">2025-08-29</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Java+Milvus搭建企业级RAG系统"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>随着大语言模型的快速发展，企业希望将其应用于内部知识库问答系统。RAG（Retrieval Augmented Generation）技术通过结合向量检索和生成式AI，为企业提供精准、实时的知识问答能力。本文将详细介绍如何使用Java+Milvus搭建一套企业级的RAG系统。</p>
</blockquote>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><h3 id="为什么需要企业级RAG系统？"><a href="#为什么需要企业级RAG系统？" class="headerlink" title="为什么需要企业级RAG系统？"></a>为什么需要企业级RAG系统？</h3><p>传统的LLM应用存在以下问题：</p>
<ul>
<li><strong>知识时效性差</strong>：模型训练数据有截止时间</li>
<li><strong>领域知识不足</strong>：通用模型缺乏企业特定知识</li>
<li><strong>幻觉问题严重</strong>：模型容易生成不存在的信息</li>
<li><strong>数据安全隐患</strong>：企业敏感数据无法直接输入</li>
</ul>
<p>RAG技术通过以下方式解决这些问题：</p>
<ol>
<li><strong>实时知识更新</strong>：可以即时纳入最新企业文档</li>
<li><strong>领域知识增强</strong>：结合企业私有知识库</li>
<li><strong>事实准确性</strong>：基于检索结果生成答案</li>
<li><strong>数据安全性</strong>：敏感数据不离开企业环境</li>
</ol>
<h2 id="RAG技术原理详解"><a href="#RAG技术原理详解" class="headerlink" title="RAG技术原理详解"></a>RAG技术原理详解</h2><h3 id="核心组件解析"><a href="#核心组件解析" class="headerlink" title="核心组件解析"></a>核心组件解析</h3><p>RAG系统由三个核心组件构成：</p>
<h4 id="1-文档处理组件（Document-Processing）"><a href="#1-文档处理组件（Document-Processing）" class="headerlink" title="1. 文档处理组件（Document Processing）"></a>1. 文档处理组件（Document Processing）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为什么需要文档预处理？</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocumentProcessor</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 文本分块：解决LLM上下文长度限制</span></span><br><span class="line">    <span class="comment">// 2. 元数据提取：支持基于属性的过滤检索</span></span><br><span class="line">    <span class="comment">// 3. 质量过滤：去除低质量内容</span></span><br><span class="line">    <span class="comment">// 4. 格式标准化：统一不同来源文档格式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>为什么要分块？</strong></p>
<ul>
<li><strong>上下文限制</strong>：大多数LLM有最大token限制（GPT-4为8192，Claude为100k）</li>
<li><strong>检索精度</strong>：小块内容更容易找到精确匹配</li>
<li><strong>计算效率</strong>：减少向量化计算量和存储成本</li>
</ul>
<h4 id="2-向量检索组件（Vector-Search）"><a href="#2-向量检索组件（Vector-Search）" class="headerlink" title="2. 向量检索组件（Vector Search）"></a>2. 向量检索组件（Vector Search）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为什么使用向量检索而不是传统检索？</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VectorSearchEngine</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 语义理解：理解查询意图而非关键词匹配</span></span><br><span class="line">    <span class="comment">// 2. 模糊匹配：处理同义词、多义词问题</span></span><br><span class="line">    <span class="comment">// 3. 跨语言支持：支持多语言内容检索</span></span><br><span class="line">    <span class="comment">// 4. 实时更新：支持动态添加新内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>向量检索优势</strong>：</p>
<ul>
<li><strong>语义匹配</strong>：传统BM25只能做关键词匹配，向量检索能理解语义</li>
<li><strong>扩展性好</strong>：支持海量数据的实时检索</li>
<li><strong>多模态支持</strong>：不仅支持文本，还支持图像、音频等</li>
</ul>
<h4 id="3-生成增强组件（Generation-Augmentation）"><a href="#3-生成增强组件（Generation-Augmentation）" class="headerlink" title="3. 生成增强组件（Generation Augmentation）"></a>3. 生成增强组件（Generation Augmentation）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为什么需要检索增强生成？</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnhancedGenerator</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 上下文增强：提供相关背景信息</span></span><br><span class="line">    <span class="comment">// 2. 事实验证：基于检索结果生成答案</span></span><br><span class="line">    <span class="comment">// 3. 引用支持：提供答案来源依据</span></span><br><span class="line">    <span class="comment">// 4. 减少幻觉：降低模型胡说八道的概率</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="技术选型分析"><a href="#技术选型分析" class="headerlink" title="技术选型分析"></a>技术选型分析</h3><h4 id="为什么选择Milvus？"><a href="#为什么选择Milvus？" class="headerlink" title="为什么选择Milvus？"></a>为什么选择Milvus？</h4><p>在众多向量数据库中选择Milvus的原因：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Milvus</th>
<th>Pinecone</th>
<th>Weaviate</th>
<th>Qdrant</th>
</tr>
</thead>
<tbody><tr>
<td><strong>开源程度</strong></td>
<td>完全开源</td>
<td>闭源SaaS</td>
<td>开源</td>
<td>开源</td>
</tr>
<tr>
<td><strong>部署方式</strong></td>
<td>自托管</td>
<td>云服务</td>
<td>自托管</td>
<td>自托管</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>水平扩展</td>
<td>有限</td>
<td>水平扩展</td>
<td>水平扩展</td>
</tr>
<tr>
<td><strong>企业支持</strong></td>
<td>商业版可用</td>
<td>企业版</td>
<td>商业版</td>
<td>企业版</td>
</tr>
<tr>
<td><strong>Java支持</strong></td>
<td>原生SDK</td>
<td>REST API</td>
<td>REST API</td>
<td>REST API</td>
</tr>
<tr>
<td><strong>成本控制</strong></td>
<td>完全可控</td>
<td>按量计费</td>
<td>可控</td>
<td>可控</td>
</tr>
</tbody></table>
<p><strong>选择Milvus的关键原因</strong>：</p>
<ol>
<li><strong>完全开源</strong>：企业可以完全控制数据和代码</li>
<li><strong>原生Java SDK</strong>：性能更好，集成更简单</li>
<li><strong>水平扩展</strong>：支持PB级数据存储</li>
<li><strong>企业级特性</strong>：提供商业支持和企业版</li>
<li><strong>活跃社区</strong>：有完善的文档和社区支持</li>
</ol>
<h2 id="系统架构设计"><a href="#系统架构设计" class="headerlink" title="系统架构设计"></a>系统架构设计</h2><h3 id="整体架构图"><a href="#整体架构图" class="headerlink" title="整体架构图"></a>整体架构图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐</span><br><span class="line">│   企业文档      │    │   文档处理      │    │   向量检索      │</span><br><span class="line">│   (PDF, Word,   │───▶│   (分块向量化)  │───▶│   (Milvus)     │</span><br><span class="line">│    Markdown)    │    │                 │    │                 │</span><br><span class="line">└─────────────────┘    └─────────────────┘    └─────────────────┘</span><br><span class="line">         │                        │                        │</span><br><span class="line">         ▼                        ▼                        ▼</span><br><span class="line">┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐</span><br><span class="line">│   用户查询      │    │   检索增强      │    │   答案生成      │</span><br><span class="line">│   (自然语言)    │───▶│   (Reranking)   │───▶│   (LLM)        │</span><br><span class="line">└─────────────────┘    └─────────────────┘    └─────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="各模块职责分析"><a href="#各模块职责分析" class="headerlink" title="各模块职责分析"></a>各模块职责分析</h3><h4 id="1-数据接入层"><a href="#1-数据接入层" class="headerlink" title="1. 数据接入层"></a>1. 数据接入层</h4><p><strong>为什么需要数据接入层？</strong></p>
<ul>
<li><strong>统一接口</strong>：屏蔽不同数据源的差异</li>
<li><strong>数据质量</strong>：过滤和清洗原始数据</li>
<li><strong>格式转换</strong>：统一转换为系统可处理的格式</li>
<li><strong>权限控制</strong>：确保数据访问的安全性</li>
</ul>
<h4 id="2-文档处理层"><a href="#2-文档处理层" class="headerlink" title="2. 文档处理层"></a>2. 文档处理层</h4><p><strong>文档处理的核心目标</strong>：</p>
<ul>
<li><strong>分块策略</strong>：确定最佳的文本分块大小</li>
<li><strong>元数据提取</strong>：提取文档的关键信息</li>
<li><strong>质量评估</strong>：过滤低质量内容</li>
<li><strong>向量化准备</strong>：为后续向量化做准备</li>
</ul>
<h4 id="3-向量检索层"><a href="#3-向量检索层" class="headerlink" title="3. 向量检索层"></a>3. 向量检索层</h4><p><strong>Milvus集群的作用</strong>：</p>
<ul>
<li><strong>高性能检索</strong>：支持毫秒级向量检索</li>
<li><strong>水平扩展</strong>：支持海量数据存储</li>
<li><strong>多索引支持</strong>：根据场景选择最佳索引</li>
<li><strong>分布式部署</strong>：保证高可用性和扩展性</li>
</ul>
<h4 id="4-生成增强层"><a href="#4-生成增强层" class="headerlink" title="4. 生成增强层"></a>4. 生成增强层</h4><p><strong>检索结果增强的必要性</strong>：</p>
<ul>
<li><strong>相关性排序</strong>：确保最重要的信息优先</li>
<li><strong>上下文整合</strong>：提供完整的背景信息</li>
<li><strong>答案验证</strong>：确保答案的准确性</li>
<li><strong>引用标注</strong>：提供答案来源依据</li>
</ul>
<h2 id="环境准备与部署"><a href="#环境准备与部署" class="headerlink" title="环境准备与部署"></a>环境准备与部署</h2><h3 id="开发环境配置"><a href="#开发环境配置" class="headerlink" title="开发环境配置"></a>开发环境配置</h3><h4 id="1-Java环境要求"><a href="#1-Java环境要求" class="headerlink" title="1. Java环境要求"></a>1. Java环境要求</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 为什么选择Java 17？ --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1. LTS版本，长期支持 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2. 性能优化，新特性支持 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 3. 企业级应用的最佳选择 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-核心依赖配置"><a href="#2-核心依赖配置" class="headerlink" title="2. 核心依赖配置"></a>2. 核心依赖配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 核心 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- Milvus Java SDK --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.milvus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>milvus-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 文档处理 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tika<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tika-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 向量化模型 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.knuddels<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jtokkit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- LLM集成 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.theokanning.openai-gpt3-java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.18.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Milvus部署方案"><a href="#Milvus部署方案" class="headerlink" title="Milvus部署方案"></a>Milvus部署方案</h3><h4 id="1-单机部署（开发环境）"><a href="#1-单机部署（开发环境）" class="headerlink" title="1. 单机部署（开发环境）"></a>1. 单机部署（开发环境）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">milvus-standalone:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.3.6</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">milvus-standalone</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19530:19530&quot;</span>  <span class="comment"># Milvus端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9091:9091&quot;</span>    <span class="comment"># Web UI端口</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./milvus:/var/lib/milvus</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;milvus&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;standalone&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="2-集群部署（生产环境）"><a href="#2-集群部署（生产环境）" class="headerlink" title="2. 集群部署（生产环境）"></a>2. 集群部署（生产环境）</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生产环境推荐配置</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">milvus-etcd:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/coreos/etcd:v3.5.5</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_AUTO_COMPACTION_MODE=revision</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_AUTO_COMPACTION_RETENTION=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_QUOTA_BACKEND_BYTES=4294967296</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_SNAPSHOT_COUNT=50000</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">milvus-minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio:RELEASE.2023-03-20T20-16-18Z</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MINIO_ACCESS_KEY:</span> <span class="string">minioadmin</span></span><br><span class="line">      <span class="attr">MINIO_SECRET_KEY:</span> <span class="string">minioadmin</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">minio</span> <span class="string">server</span> <span class="string">/minio_data</span> <span class="string">--console-address</span> <span class="string">:9001</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">milvus-datacoord:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.3.6</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;milvus&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;datacoord&quot;</span>]</span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus-etcd</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus-minio</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">milvus-datanode:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.3.6</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;milvus&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;datanode&quot;</span>]</span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus-datacoord</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">milvus-querycoord:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.3.6</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;milvus&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;querycoord&quot;</span>]</span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus-etcd</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">milvus-querynode:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.3.6</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;milvus&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;querynode&quot;</span>]</span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus-querycoord</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">milvus-indexcoord:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.3.6</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;milvus&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;indexcoord&quot;</span>]</span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus-etcd</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">milvus-indexnode:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.3.6</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;milvus&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;indexnode&quot;</span>]</span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus-indexcoord</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">milvus-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.3.6</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19530:19530&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;milvus&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;proxy&quot;</span>]</span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus-querycoord</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus-datacoord</span></span><br></pre></td></tr></table></figure>

<p><strong>为什么采用集群部署？</strong></p>
<ol>
<li><strong>高可用性</strong>：单点故障不会影响整个系统</li>
<li><strong>水平扩展</strong>：可以根据数据量动态扩展节点</li>
<li><strong>负载均衡</strong>：分散读写压力，提高并发性能</li>
<li><strong>数据安全</strong>：多副本存储，保证数据不丢失</li>
</ol>
<h2 id="核心实现代码"><a href="#核心实现代码" class="headerlink" title="核心实现代码"></a>核心实现代码</h2><h3 id="1-配置文件设计"><a href="#1-配置文件设计" class="headerlink" title="1. 配置文件设计"></a>1. 配置文件设计</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">milvus:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">19530</span></span><br><span class="line">  <span class="attr">collection:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">enterprise_docs</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;企业文档知识库&quot;</span></span><br><span class="line">    <span class="attr">vector:</span></span><br><span class="line">      <span class="attr">dimension:</span> <span class="number">1536</span>  <span class="comment"># OpenAI text-embedding-ada-002维度</span></span><br><span class="line">      <span class="attr">metric-type:</span> <span class="string">COSINE</span>  <span class="comment"># 相似度度量方式</span></span><br><span class="line">      <span class="attr">index-type:</span> <span class="string">IVF_FLAT</span>  <span class="comment"># 索引类型</span></span><br><span class="line">      <span class="attr">index-params:</span></span><br><span class="line">        <span class="attr">nlist:</span> <span class="number">128</span>  <span class="comment"># 聚类中心数量</span></span><br><span class="line"></span><br><span class="line"><span class="attr">openai:</span></span><br><span class="line">  <span class="attr">api-key:</span> <span class="string">$&#123;OPENAI_API_KEY&#125;</span></span><br><span class="line">  <span class="attr">model:</span> <span class="string">gpt-3.5-turbo</span></span><br><span class="line">  <span class="attr">embedding-model:</span> <span class="string">text-embedding-ada-002</span></span><br><span class="line">  <span class="attr">max-tokens:</span> <span class="number">4000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">document:</span></span><br><span class="line">  <span class="attr">chunk:</span></span><br><span class="line">    <span class="attr">size:</span> <span class="number">1000</span>  <span class="comment"># 分块大小</span></span><br><span class="line">    <span class="attr">overlap:</span> <span class="number">200</span>  <span class="comment"># 分块重叠</span></span><br><span class="line">  <span class="attr">supported-types:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pdf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">txt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">md</span></span><br></pre></td></tr></table></figure>

<h3 id="2-文档处理服务"><a href="#2-文档处理服务" class="headerlink" title="2. 文档处理服务"></a>2. 文档处理服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocumentProcessingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MilvusService milvusService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmbeddingService embeddingService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文档处理核心流程</span></span><br><span class="line"><span class="comment">     * 为什么需要这个完整的处理流程？</span></span><br><span class="line"><span class="comment">     * 1. 文档解析：将各种格式转换为纯文本</span></span><br><span class="line"><span class="comment">     * 2. 文本分块：解决LLM上下文长度限制</span></span><br><span class="line"><span class="comment">     * 3. 向量化：转换为向量表示</span></span><br><span class="line"><span class="comment">     * 4. 存储：保存到向量数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDocument</span><span class="params">(MultipartFile file, String category, String tags)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 文档解析</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> parseDocument(file);</span><br><span class="line">            log.info(<span class="string">&quot;文档解析完成，内容长度: &#123;&#125;&quot;</span>, content.length());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 文本分块</span></span><br><span class="line">            List&lt;DocumentChunk&gt; chunks = splitDocument(content, category, tags);</span><br><span class="line">            log.info(<span class="string">&quot;文本分块完成，分块数量: &#123;&#125;&quot;</span>, chunks.size());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 批量向量化</span></span><br><span class="line">            List&lt;<span class="type">float</span>[]&gt; vectors = embeddingService.embedTexts(</span><br><span class="line">                chunks.stream()</span><br><span class="line">                    .map(DocumentChunk::getContent)</span><br><span class="line">                    .collect(Collectors.toList())</span><br><span class="line">            );</span><br><span class="line">            log.info(<span class="string">&quot;向量化完成，向量维度: &#123;&#125;&quot;</span>, vectors.get(<span class="number">0</span>).length);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 存储到Milvus</span></span><br><span class="line">            milvusService.insertDocuments(chunks, vectors);</span><br><span class="line">            log.info(<span class="string">&quot;文档存储完成，总计: &#123;&#125; 个分块&quot;</span>, chunks.size());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;文档处理失败: &#123;&#125;&quot;</span>, file.getOriginalFilename(), e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;文档处理失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文档解析 - 支持多种格式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">parseDocument</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>).toLowerCase();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">input</span> <span class="operator">=</span> file.getInputStream()) &#123;</span><br><span class="line">            <span class="type">AutoDetectParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AutoDetectParser</span>();</span><br><span class="line">            <span class="type">BodyContentHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BodyContentHandler</span>(-<span class="number">1</span>); <span class="comment">// 不限制内容大小</span></span><br><span class="line">            <span class="type">Metadata</span> <span class="variable">metadata</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Metadata</span>();</span><br><span class="line">            <span class="type">ParseContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParseContext</span>();</span><br><span class="line">            </span><br><span class="line">            parser.parse(input, handler, metadata, context);</span><br><span class="line">            <span class="keyword">return</span> handler.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 智能文本分块策略</span></span><br><span class="line"><span class="comment">     * 为什么需要智能分块？</span></span><br><span class="line"><span class="comment">     * 1. 保持语义完整性：避免在句子中间截断</span></span><br><span class="line"><span class="comment">     * 2. 控制分块大小：确保每个分块在合理范围内</span></span><br><span class="line"><span class="comment">     * 3. 重叠策略：保持上下文连贯性</span></span><br><span class="line"><span class="comment">     * 4. 元数据保留：保留原始文档信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;DocumentChunk&gt; <span class="title function_">splitDocument</span><span class="params">(String content, String category, String tags)</span> &#123;</span><br><span class="line">        List&lt;DocumentChunk&gt; chunks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 按段落分割</span></span><br><span class="line">        String[] paragraphs = content.split(<span class="string">&quot;\\n\\s*\\n&quot;</span>);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">currentChunk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String paragraph : paragraphs) &#123;</span><br><span class="line">            <span class="comment">// 如果添加当前段落会超过限制，开始新分块</span></span><br><span class="line">            <span class="keyword">if</span> (currentChunk.length() + paragraph.length() &gt; </span><br><span class="line">                documentConfig.getChunkSize() - documentConfig.getOverlap()) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (currentChunk.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    chunks.add(createDocumentChunk(currentChunk.toString(), </span><br><span class="line">                                                 category, tags, chunks.size()));</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 保留重叠内容</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">overlapContent</span> <span class="operator">=</span> getOverlapContent(currentChunk.toString());</span><br><span class="line">                    currentChunk = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(overlapContent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (currentChunk.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                currentChunk.append(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            currentChunk.append(paragraph);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理最后一个分块</span></span><br><span class="line">        <span class="keyword">if</span> (currentChunk.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            chunks.add(createDocumentChunk(currentChunk.toString(), </span><br><span class="line">                                         category, tags, chunks.size()));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chunks;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取重叠内容 - 保持上下文连贯性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getOverlapContent</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        String[] sentences = content.split(<span class="string">&quot;(?&lt;=[.!?])\\s+&quot;</span>);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">overlap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">overlapSize</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 从后往前添加句子，直到达到重叠大小</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> sentences.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (overlapSize + sentences[i].length() &gt; documentConfig.getOverlap()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            overlap.insert(<span class="number">0</span>, sentences[i] + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            overlapSize += sentences[i].length();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> overlap.toString().trim();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建文档分块对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> DocumentChunk <span class="title function_">createDocumentChunk</span><span class="params">(String content, String category, </span></span><br><span class="line"><span class="params">                                            String tags, <span class="type">int</span> chunkIndex)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DocumentChunk.builder()</span><br><span class="line">                .id(UUID.randomUUID().toString())</span><br><span class="line">                .content(content)</span><br><span class="line">                .category(category)</span><br><span class="line">                .tags(tags)</span><br><span class="line">                .chunkIndex(chunkIndex)</span><br><span class="line">                .createTime(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Milvus服务封装"><a href="#3-Milvus服务封装" class="headerlink" title="3. Milvus服务封装"></a>3. Milvus服务封装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MilvusService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MilvusClient milvusClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MilvusConfig milvusConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化集合</span></span><br><span class="line"><span class="comment">     * 为什么需要集合初始化？</span></span><br><span class="line"><span class="comment">     * 1. 定义数据结构：指定向量维度和字段类型</span></span><br><span class="line"><span class="comment">     * 2. 创建索引：为向量字段创建合适的索引</span></span><br><span class="line"><span class="comment">     * 3. 设置参数：配置集合的各种参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initCollection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 检查集合是否存在</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">exists</span> <span class="operator">=</span> milvusClient.hasCollection(</span><br><span class="line">                HasCollectionParam.newBuilder()</span><br><span class="line">                    .withCollectionName(milvusConfig.getCollectionName())</span><br><span class="line">                    .build()</span><br><span class="line">            ).getData();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!exists) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;创建Milvus集合: &#123;&#125;&quot;</span>, milvusConfig.getCollectionName());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 创建集合</span></span><br><span class="line">                milvusClient.createCollection(</span><br><span class="line">                    CreateCollectionParam.newBuilder()</span><br><span class="line">                        .withCollectionName(milvusConfig.getCollectionName())</span><br><span class="line">                        .withDescription(milvusConfig.getDescription())</span><br><span class="line">                        .addFieldType(FieldType.newBuilder()</span><br><span class="line">                            .withName(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                            .withDataType(DataType.VarChar)</span><br><span class="line">                            .withMaxLength(<span class="number">64</span>)</span><br><span class="line">                            .withPrimaryKey(<span class="literal">true</span>)</span><br><span class="line">                            .withAutoID(<span class="literal">false</span>)</span><br><span class="line">                            .build())</span><br><span class="line">                        .addFieldType(FieldType.newBuilder()</span><br><span class="line">                            .withName(<span class="string">&quot;vector&quot;</span>)</span><br><span class="line">                            .withDataType(DataType.FloatVector)</span><br><span class="line">                            .withDimension(milvusConfig.getVectorDimension())</span><br><span class="line">                            .build())</span><br><span class="line">                        .addFieldType(FieldType.newBuilder()</span><br><span class="line">                            .withName(<span class="string">&quot;content&quot;</span>)</span><br><span class="line">                            .withDataType(DataType.VarChar)</span><br><span class="line">                            .withMaxLength(<span class="number">65535</span>)</span><br><span class="line">                            .build())</span><br><span class="line">                        .addFieldType(FieldType.newBuilder()</span><br><span class="line">                            .withName(<span class="string">&quot;category&quot;</span>)</span><br><span class="line">                            .withDataType(DataType.VarChar)</span><br><span class="line">                            .withMaxLength(<span class="number">100</span>)</span><br><span class="line">                            .build())</span><br><span class="line">                        .addFieldType(FieldType.newBuilder()</span><br><span class="line">                            .withName(<span class="string">&quot;tags&quot;</span>)</span><br><span class="line">                            .withDataType(DataType.VarChar)</span><br><span class="line">                            .withMaxLength(<span class="number">500</span>)</span><br><span class="line">                            .build())</span><br><span class="line">                        .addFieldType(FieldType.newBuilder()</span><br><span class="line">                            .withName(<span class="string">&quot;chunk_index&quot;</span>)</span><br><span class="line">                            .withDataType(DataType.Int64)</span><br><span class="line">                            .build())</span><br><span class="line">                        .addFieldType(FieldType.newBuilder()</span><br><span class="line">                            .withName(<span class="string">&quot;create_time&quot;</span>)</span><br><span class="line">                            .withDataType(DataType.Int64)</span><br><span class="line">                            .build())</span><br><span class="line">                        .build()</span><br><span class="line">                );</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 创建索引</span></span><br><span class="line">                createIndex();</span><br><span class="line">                </span><br><span class="line">                log.info(<span class="string">&quot;Milvus集合创建成功&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Milvus集合初始化失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Milvus集合初始化失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建向量索引</span></span><br><span class="line"><span class="comment">     * 为什么需要合适的索引？</span></span><br><span class="line"><span class="comment">     * 1. 检索性能：索引可以大大提升检索速度</span></span><br><span class="line"><span class="comment">     * 2. 内存效率：减少内存使用</span></span><br><span class="line"><span class="comment">     * 3. 准确性：不同索引类型对准确性影响不同</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createIndex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 为向量字段创建IVF_FLAT索引</span></span><br><span class="line">            <span class="type">CreateIndexParam</span> <span class="variable">indexParam</span> <span class="operator">=</span> CreateIndexParam.newBuilder()</span><br><span class="line">                .withCollectionName(milvusConfig.getCollectionName())</span><br><span class="line">                .withFieldName(<span class="string">&quot;vector&quot;</span>)</span><br><span class="line">                .withIndexType(IndexType.IVF_FLAT)</span><br><span class="line">                .withMetricType(MetricType.COSINE)</span><br><span class="line">                .withExtraParam(<span class="string">&quot;&#123;\&quot;nlist\&quot;: 128&#125;&quot;</span>)</span><br><span class="line">                .withSyncMode(Boolean.FALSE)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            milvusClient.createIndex(indexParam);</span><br><span class="line">            log.info(<span class="string">&quot;向量索引创建成功&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;向量索引创建失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;向量索引创建失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量插入文档</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertDocuments</span><span class="params">(List&lt;DocumentChunk&gt; chunks, List&lt;<span class="type">float</span>[]&gt; vectors)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;InsertParam.Field&gt; fields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ID字段</span></span><br><span class="line">            List&lt;String&gt; ids = chunks.stream()</span><br><span class="line">                .map(DocumentChunk::getId)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            fields.add(<span class="keyword">new</span> <span class="title class_">InsertParam</span>.Field(<span class="string">&quot;id&quot;</span>, ids));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 向量字段</span></span><br><span class="line">            fields.add(<span class="keyword">new</span> <span class="title class_">InsertParam</span>.Field(<span class="string">&quot;vector&quot;</span>, vectors));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 内容字段</span></span><br><span class="line">            List&lt;String&gt; contents = chunks.stream()</span><br><span class="line">                .map(DocumentChunk::getContent)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            fields.add(<span class="keyword">new</span> <span class="title class_">InsertParam</span>.Field(<span class="string">&quot;content&quot;</span>, contents));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 其他字段...</span></span><br><span class="line">            List&lt;String&gt; categories = chunks.stream()</span><br><span class="line">                .map(DocumentChunk::getCategory)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">            fields.add(<span class="keyword">new</span> <span class="title class_">InsertParam</span>.Field(<span class="string">&quot;category&quot;</span>, categories));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行插入</span></span><br><span class="line">            <span class="type">InsertParam</span> <span class="variable">insertParam</span> <span class="operator">=</span> InsertParam.newBuilder()</span><br><span class="line">                .withCollectionName(milvusConfig.getCollectionName())</span><br><span class="line">                .withFields(fields)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="type">InsertResponse</span> <span class="variable">response</span> <span class="operator">=</span> milvusClient.insert(insertParam);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 刷新数据到磁盘</span></span><br><span class="line">            milvusClient.flush(FlushParam.newBuilder()</span><br><span class="line">                .withCollectionName(milvusConfig.getCollectionName())</span><br><span class="line">                .addFlushCollectionName(milvusConfig.getCollectionName())</span><br><span class="line">                .build());</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;成功插入 &#123;&#125; 个文档分块&quot;</span>, chunks.size());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;文档插入失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;文档插入失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向量检索</span></span><br><span class="line"><span class="comment">     * 为什么需要多重过滤？</span></span><br><span class="line"><span class="comment">     * 1. 相关性过滤：基于相似度阈值</span></span><br><span class="line"><span class="comment">     * 2. 类别过滤：基于文档类别</span></span><br><span class="line"><span class="comment">     * 3. 时间过滤：基于创建时间</span></span><br><span class="line"><span class="comment">     * 4. 权限过滤：基于用户权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SearchResult&gt; <span class="title function_">search</span><span class="params">(<span class="type">float</span>[] queryVector, <span class="type">int</span> topK, </span></span><br><span class="line"><span class="params">                                   String category, Date startTime)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构建搜索参数</span></span><br><span class="line">            <span class="type">SearchParam</span> <span class="variable">searchParam</span> <span class="operator">=</span> SearchParam.newBuilder()</span><br><span class="line">                .withCollectionName(milvusConfig.getCollectionName())</span><br><span class="line">                .withVectorFieldName(<span class="string">&quot;vector&quot;</span>)</span><br><span class="line">                .withVectors(Collections.singletonList(queryVector))</span><br><span class="line">                .withTopK(topK)</span><br><span class="line">                .withMetricType(MetricType.COSINE)</span><br><span class="line">                .withParams(<span class="string">&quot;&#123;\&quot;nprobe\&quot;: 10&#125;&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 添加过滤条件</span></span><br><span class="line">            <span class="keyword">if</span> (category != <span class="literal">null</span> || startTime != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (category != <span class="literal">null</span>) &#123;</span><br><span class="line">                    filter.append(<span class="string">&quot;category == \&quot;&quot;</span>).append(category).append(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (startTime != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (filter.length() &gt; <span class="number">0</span>) filter.append(<span class="string">&quot; and &quot;</span>);</span><br><span class="line">                    filter.append(<span class="string">&quot;create_time &gt;= &quot;</span>).append(startTime.getTime());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                searchParam = searchParam.toBuilder()</span><br><span class="line">                    .withExpr(filter.toString())</span><br><span class="line">                    .build();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行搜索</span></span><br><span class="line">            <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> milvusClient.search(searchParam);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 解析结果</span></span><br><span class="line">            <span class="keyword">return</span> parseSearchResults(response);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;向量检索失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;向量检索失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析搜索结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SearchResult&gt; <span class="title function_">parseSearchResults</span><span class="params">(SearchResponse response)</span> &#123;</span><br><span class="line">        List&lt;SearchResult&gt; results = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        List&lt;List&lt;SearchResponse.QueryResult&gt;&gt; queryResults = response.getResults();</span><br><span class="line">        <span class="keyword">for</span> (List&lt;SearchResponse.QueryResult&gt; queryResult : queryResults) &#123;</span><br><span class="line">            <span class="keyword">for</span> (SearchResponse.QueryResult result : queryResult) &#123;</span><br><span class="line">                <span class="type">SearchResult</span> <span class="variable">searchResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>();</span><br><span class="line">                searchResult.setId(result.getEntity().get(<span class="string">&quot;id&quot;</span>).toString());</span><br><span class="line">                searchResult.setContent(result.getEntity().get(<span class="string">&quot;content&quot;</span>).toString());</span><br><span class="line">                searchResult.setScore(result.getScore());</span><br><span class="line">                searchResult.setCategory(result.getEntity().get(<span class="string">&quot;category&quot;</span>).toString());</span><br><span class="line">                results.add(searchResult);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-检索增强生成服务"><a href="#4-检索增强生成服务" class="headerlink" title="4. 检索增强生成服务"></a>4. 检索增强生成服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmbeddingService embeddingService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MilvusService milvusService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OpenAiService openAiService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RAG问答核心流程</span></span><br><span class="line"><span class="comment">     * 为什么需要这个完整的RAG流程？</span></span><br><span class="line"><span class="comment">     * 1. 查询理解：准确理解用户意图</span></span><br><span class="line"><span class="comment">     * 2. 检索增强：获取相关上下文</span></span><br><span class="line"><span class="comment">     * 3. 答案生成：基于检索结果生成答案</span></span><br><span class="line"><span class="comment">     * 4. 引用标注：提供答案来源依据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> RagResponse <span class="title function_">answerQuestion</span><span class="params">(String question, String category, </span></span><br><span class="line"><span class="params">                                    Integer maxResults)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;开始处理问题: &#123;&#125;&quot;</span>, question);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 1. 问题向量化</span></span><br><span class="line">            <span class="type">float</span>[] queryVector = embeddingService.embedText(question);</span><br><span class="line">            log.info(<span class="string">&quot;问题向量化完成，向量维度: &#123;&#125;&quot;</span>, queryVector.length);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 向量检索</span></span><br><span class="line">            List&lt;SearchResult&gt; searchResults = milvusService.search(</span><br><span class="line">                queryVector, </span><br><span class="line">                maxResults != <span class="literal">null</span> ? maxResults : <span class="number">5</span>,</span><br><span class="line">                category,</span><br><span class="line">                <span class="literal">null</span> <span class="comment">// 可以根据需要添加时间过滤</span></span><br><span class="line">            );</span><br><span class="line">            log.info(<span class="string">&quot;检索完成，找到 &#123;&#125; 个相关文档&quot;</span>, searchResults.size());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 结果重排序和过滤</span></span><br><span class="line">            List&lt;SearchResult&gt; filteredResults = rerankAndFilter(searchResults, question);</span><br><span class="line">            log.info(<span class="string">&quot;重排序后剩余 &#123;&#125; 个文档&quot;</span>, filteredResults.size());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 构建上下文</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">context</span> <span class="operator">=</span> buildContext(filteredResults);</span><br><span class="line">            log.info(<span class="string">&quot;上下文构建完成，长度: &#123;&#125; 字符&quot;</span>, context.length());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 5. 生成答案</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> generateAnswer(question, context);</span><br><span class="line">            log.info(<span class="string">&quot;答案生成完成，长度: &#123;&#125; 字符&quot;</span>, answer.length());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 6. 构建引用</span></span><br><span class="line">            List&lt;Reference&gt; references = buildReferences(filteredResults);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> RagResponse.builder()</span><br><span class="line">                    .question(question)</span><br><span class="line">                    .answer(answer)</span><br><span class="line">                    .references(references)</span><br><span class="line">                    .searchResults(filteredResults)</span><br><span class="line">                    .build();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;RAG问答处理失败: &#123;&#125;&quot;</span>, question, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;问答处理失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 结果重排序和过滤</span></span><br><span class="line"><span class="comment">     * 为什么需要重排序？</span></span><br><span class="line"><span class="comment">     * 1. 提高相关性：基于问题和文档的相关性重新排序</span></span><br><span class="line"><span class="comment">     * 2. 过滤低质量：去除相似度过低的结果</span></span><br><span class="line"><span class="comment">     * 3. 多样性保证：避免返回过于相似的文档</span></span><br><span class="line"><span class="comment">     * 4. 长度控制：控制上下文总长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SearchResult&gt; <span class="title function_">rerankAndFilter</span><span class="params">(List&lt;SearchResult&gt; results, String question)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 按相似度阈值过滤</span></span><br><span class="line">        results = results.stream()</span><br><span class="line">            .filter(r -&gt; r.getScore() &gt; <span class="number">0.7</span>) <span class="comment">// 相似度阈值</span></span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 按相关性重排序（这里使用简单的BM25-like算法）</span></span><br><span class="line">        results.forEach(result -&gt; &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">relevanceScore</span> <span class="operator">=</span> calculateRelevanceScore(question, result.getContent());</span><br><span class="line">            result.setScore(result.getScore() * <span class="number">0.7</span> + relevanceScore * <span class="number">0.3</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 按新得分排序</span></span><br><span class="line">        results.sort((a, b) -&gt; Double.compare(b.getScore(), a.getScore()));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 限制数量和长度</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">maxLength</span> <span class="operator">=</span> <span class="number">8000</span>; <span class="comment">// 上下文最大长度</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">currentLength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        List&lt;SearchResult&gt; filtered = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (SearchResult result : results) &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentLength + result.getContent().length() &gt; maxLength) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filtered.add(result);</span><br><span class="line">            currentLength += result.getContent().length();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> filtered;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算相关性得分</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">calculateRelevanceScore</span><span class="params">(String question, String content)</span> &#123;</span><br><span class="line">        <span class="comment">// 简单的词频统计</span></span><br><span class="line">        String[] questionWords = question.toLowerCase().split(<span class="string">&quot;\\s+&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">contentLower</span> <span class="operator">=</span> content.toLowerCase();</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">matchCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (String word : questionWords) &#123;</span><br><span class="line">            <span class="keyword">if</span> (contentLower.contains(word)) &#123;</span><br><span class="line">                matchCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (<span class="type">double</span>) matchCount / questionWords.length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建上下文</span></span><br><span class="line"><span class="comment">     * 为什么需要精心构建上下文？</span></span><br><span class="line"><span class="comment">     * 1. 长度控制：避免超出LLM上下文限制</span></span><br><span class="line"><span class="comment">     * 2. 信息密度：选择最相关的信息</span></span><br><span class="line"><span class="comment">     * 3. 结构化：保持文档的逻辑结构</span></span><br><span class="line"><span class="comment">     * 4. 引用标记：为后续引用做准备</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">buildContext</span><span class="params">(List&lt;SearchResult&gt; results)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        context.append(<span class="string">&quot;基于以下企业文档内容来回答问题：\n\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; results.size(); i++) &#123;</span><br><span class="line">            <span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> results.get(i);</span><br><span class="line">            context.append(String.format(<span class="string">&quot;[文档%d] (相似度: %.3f, 类别: %s)\n&quot;</span>,</span><br><span class="line">                i + <span class="number">1</span>, result.getScore(), result.getCategory()));</span><br><span class="line">            context.append(result.getContent());</span><br><span class="line">            context.append(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        context.append(<span class="string">&quot;请基于上述文档内容准确回答问题，如果文档中没有相关信息，请明确说明。&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> context.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成答案</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateAnswer</span><span class="params">(String question, String context)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">prompt</span> <span class="operator">=</span> String.format(</span><br><span class="line">            <span class="string">&quot;请基于以下上下文信息回答问题。要求：\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;1. 答案必须基于提供的上下文信息\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;2. 如果上下文信息不足以回答，请明确说明\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;3. 保持答案的准确性和客观性\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;4. 适当引用文档来源\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;上下文信息：\n%s\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;问题：%s\n\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;答案：&quot;</span>,</span><br><span class="line">            context, question</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> openAiService.generateAnswer(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建引用列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Reference&gt; <span class="title function_">buildReferences</span><span class="params">(List&lt;SearchResult&gt; results)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> results.stream()</span><br><span class="line">            .map(result -&gt; Reference.builder()</span><br><span class="line">                .documentId(result.getId())</span><br><span class="line">                .content(result.getContent().substring(<span class="number">0</span>, </span><br><span class="line">                    Math.min(<span class="number">200</span>, result.getContent().length())))</span><br><span class="line">                .similarityScore(result.getScore())</span><br><span class="line">                .category(result.getCategory())</span><br><span class="line">                .build())</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-向量化服务"><a href="#5-向量化服务" class="headerlink" title="5. 向量化服务"></a>5. 向量化服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmbeddingService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OpenAiService openAiService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文本向量化</span></span><br><span class="line"><span class="comment">     * 为什么需要高质量的向量化？</span></span><br><span class="line"><span class="comment">     * 1. 语义理解：准确捕捉文本语义信息</span></span><br><span class="line"><span class="comment">     * 2. 一致性：相同语义的文本应该有相似的向量</span></span><br><span class="line"><span class="comment">     * 3. 维度合适：平衡精度和计算效率</span></span><br><span class="line"><span class="comment">     * 4. 多语言支持：支持企业多语言环境</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span>[] embedText(String text) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 文本预处理</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">processedText</span> <span class="operator">=</span> preprocessText(text);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 调用OpenAI Embedding API</span></span><br><span class="line">            <span class="type">EmbeddingResult</span> <span class="variable">result</span> <span class="operator">=</span> openAiService.createEmbedding(processedText);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> convertToFloatArray(result.getData().get(<span class="number">0</span>).getEmbedding());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;文本向量化失败: &#123;&#125;&quot;</span>, text.substring(<span class="number">0</span>, <span class="number">100</span>), e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;文本向量化失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量文本向量化</span></span><br><span class="line"><span class="comment">     * 为什么需要批量处理？</span></span><br><span class="line"><span class="comment">     * 1. 提高效率：减少API调用次数</span></span><br><span class="line"><span class="comment">     * 2. 降低成本：批量调用通常更便宜</span></span><br><span class="line"><span class="comment">     * 3. 错误处理：统一处理批量错误</span></span><br><span class="line"><span class="comment">     * 4. 资源控制：避免突发流量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="type">float</span>[]&gt; embedTexts(List&lt;String&gt; texts) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 分批处理，避免单次请求过大</span></span><br><span class="line">            List&lt;<span class="type">float</span>[]&gt; allEmbeddings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// 根据API限制调整</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; texts.size(); i += batchSize) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">endIndex</span> <span class="operator">=</span> Math.min(i + batchSize, texts.size());</span><br><span class="line">                List&lt;String&gt; batch = texts.subList(i, endIndex);</span><br><span class="line">                </span><br><span class="line">                List&lt;String&gt; processedBatch = batch.stream()</span><br><span class="line">                    .map(<span class="built_in">this</span>::preprocessText)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">                </span><br><span class="line">                <span class="type">EmbeddingResult</span> <span class="variable">result</span> <span class="operator">=</span> openAiService.createEmbeddings(processedBatch);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> (Embedding embedding : result.getData()) &#123;</span><br><span class="line">                    allEmbeddings.add(convertToFloatArray(embedding.getEmbedding()));</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 添加延迟，避免触发API限流</span></span><br><span class="line">                <span class="keyword">if</span> (endIndex &lt; texts.size()) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> allEmbeddings;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;批量文本向量化失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;批量文本向量化失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文本预处理</span></span><br><span class="line"><span class="comment">     * 为什么需要预处理？</span></span><br><span class="line"><span class="comment">     * 1. 长度控制：确保文本在模型限制内</span></span><br><span class="line"><span class="comment">     * 2. 格式清理：去除多余的格式字符</span></span><br><span class="line"><span class="comment">     * 3. 语言标准化：统一语言编码</span></span><br><span class="line"><span class="comment">     * 4. 质量提升：提高向量化质量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">preprocessText</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="literal">null</span> || text.trim().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 去除多余空白字符</span></span><br><span class="line">        text = text.replaceAll(<span class="string">&quot;\\s+&quot;</span>, <span class="string">&quot; &quot;</span>).trim();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 控制长度</span></span><br><span class="line">        <span class="keyword">if</span> (text.length() &gt; <span class="number">8000</span>) &#123; <span class="comment">// OpenAI的合理长度限制</span></span><br><span class="line">            text = text.substring(<span class="number">0</span>, <span class="number">8000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 去除特殊字符</span></span><br><span class="line">        text = text.replaceAll(<span class="string">&quot;[\\x00-\\x1F\\x7F-\\x9F]&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> text;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换向量格式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span>[] convertToFloatArray(List&lt;Double&gt; embedding) &#123;</span><br><span class="line">        <span class="type">float</span>[] result = <span class="keyword">new</span> <span class="title class_">float</span>[embedding.size()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; embedding.size(); i++) &#123;</span><br><span class="line">            result[i] = embedding.get(i).floatValue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="性能优化策略"><a href="#性能优化策略" class="headerlink" title="性能优化策略"></a>性能优化策略</h2><h3 id="1-索引优化"><a href="#1-索引优化" class="headerlink" title="1. 索引优化"></a>1. 索引优化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexOptimizationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 动态索引选择策略</span></span><br><span class="line"><span class="comment">     * 为什么需要动态索引选择？</span></span><br><span class="line"><span class="comment">     * 1. 数据特征：不同数据适合不同索引</span></span><br><span class="line"><span class="comment">     * 2. 查询模式：不同查询需要不同索引</span></span><br><span class="line"><span class="comment">     * 3. 性能平衡：平衡构建时间和查询时间</span></span><br><span class="line"><span class="comment">     * 4. 资源限制：考虑内存和存储限制</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeIndex</span><span class="params">(String collectionName, DatasetCharacteristics characteristics)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据数据量选择索引类型</span></span><br><span class="line">        <span class="keyword">if</span> (characteristics.getDataSize() &lt; <span class="number">10000</span>) &#123;</span><br><span class="line">            <span class="comment">// 小数据集：使用FLAT索引，准确性优先</span></span><br><span class="line">            createFlatIndex(collectionName);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (characteristics.getDataSize() &lt; <span class="number">100000</span>) &#123;</span><br><span class="line">            <span class="comment">// 中等数据集：使用IVF_FLAT</span></span><br><span class="line">            createIvfFlatIndex(collectionName, <span class="number">128</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 大数据集：使用IVF_PQ，压缩存储</span></span><br><span class="line">            createIvfPQIndex(collectionName, <span class="number">128</span>, <span class="number">64</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IVF_FLAT索引：平衡准确性和性能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createIvfFlatIndex</span><span class="params">(String collectionName, <span class="type">int</span> nlist)</span> &#123;</span><br><span class="line">        <span class="comment">// nlist：聚类中心数量，影响索引构建时间和查询性能</span></span><br><span class="line">        <span class="comment">// 经验值：nlist = sqrt(数据量)，但不超过4*sqrt(数据量)</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IVF_PQ索引：牺牲少量准确性，获得更好的压缩效果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createIvfPQIndex</span><span class="params">(String collectionName, <span class="type">int</span> nlist, <span class="type">int</span> m)</span> &#123;</span><br><span class="line">        <span class="comment">// m：向量被分割的段数，影响压缩率和准确性</span></span><br><span class="line">        <span class="comment">// 经验值：m = 维度/4，但不超过维度/2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-缓存策略"><a href="#2-缓存策略" class="headerlink" title="2. 缓存策略"></a>2. 缓存策略</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多级缓存策略</span></span><br><span class="line"><span class="comment">     * 为什么需要多级缓存？</span></span><br><span class="line"><span class="comment">     * 1. 查询加速：避免重复向量检索</span></span><br><span class="line"><span class="comment">     * 2. 成本控制：减少向量化API调用</span></span><br><span class="line"><span class="comment">     * 3. 用户体验：提高响应速度</span></span><br><span class="line"><span class="comment">     * 4. 系统稳定性：减轻下游服务压力</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 向量缓存：缓存查询向量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">VECTOR_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;rag:vector:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">VECTOR_CACHE_TTL</span> <span class="operator">=</span> Duration.ofHours(<span class="number">24</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 结果缓存：缓存检索结果</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RESULT_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;rag:result:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">RESULT_CACHE_TTL</span> <span class="operator">=</span> Duration.ofHours(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 答案缓存：缓存完整答案</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ANSWER_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;rag:answer:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Duration</span> <span class="variable">ANSWER_CACHE_TTL</span> <span class="operator">=</span> Duration.ofMinutes(<span class="number">30</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取缓存的向量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span>[] getCachedVector(String text) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> VECTOR_CACHE_PREFIX + DigestUtils.md5Hex(text);</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">float</span>[]) redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存向量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cacheVector</span><span class="params">(String text, <span class="type">float</span>[] vector)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> VECTOR_CACHE_PREFIX + DigestUtils.md5Hex(text);</span><br><span class="line">        redisTemplate.opsForValue().set(key, vector, VECTOR_CACHE_TTL);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取缓存的检索结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SearchResult&gt; <span class="title function_">getCachedResults</span><span class="params">(String query, String category)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RESULT_CACHE_PREFIX + DigestUtils.md5Hex(query + category);</span><br><span class="line">        <span class="keyword">return</span> (List&lt;SearchResult&gt;) redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存检索结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cacheResults</span><span class="params">(String query, String category, List&lt;SearchResult&gt; results)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RESULT_CACHE_PREFIX + DigestUtils.md5Hex(query + category);</span><br><span class="line">        redisTemplate.opsForValue().set(key, results, RESULT_CACHE_TTL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-并发控制"><a href="#3-并发控制" class="headerlink" title="3. 并发控制"></a>3. 并发控制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池配置</span></span><br><span class="line"><span class="comment">     * 为什么需要自定义线程池？</span></span><br><span class="line"><span class="comment">     * 1. 控制并发：避免过多的并发请求</span></span><br><span class="line"><span class="comment">     * 2. 资源隔离：与Web容器线程池分离</span></span><br><span class="line"><span class="comment">     * 3. 性能监控：便于监控和调优</span></span><br><span class="line"><span class="comment">     * 4. 错误隔离：避免某个任务影响整个系统</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean(&quot;ragTaskExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title function_">ragTaskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 核心线程数：根据CPU核心数设置</span></span><br><span class="line">        executor.setCorePoolSize(Runtime.getRuntime().availableProcessors());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 最大线程数：核心线程数的2倍</span></span><br><span class="line">        executor.setMaxPoolSize(Runtime.getRuntime().availableProcessors() * <span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 队列容量：控制等待任务数量</span></span><br><span class="line">        executor.setQueueCapacity(<span class="number">100</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 线程名前缀：便于日志追踪</span></span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;rag-task-&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 拒绝策略：调用者运行</span></span><br><span class="line">        executor.setRejectedExecutionHandler(<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 空闲线程存活时间</span></span><br><span class="line">        executor.setKeepAliveSeconds(<span class="number">60</span>);</span><br><span class="line">        </span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="监控和运维"><a href="#监控和运维" class="headerlink" title="监控和运维"></a>监控和运维</h2><h3 id="1-指标监控"><a href="#1-指标监控" class="headerlink" title="1. 指标监控"></a>1. 指标监控</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetricsService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MeterRegistry meterRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计数器：记录各种操作次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter documentProcessedCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter searchRequestCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter answerGeneratedCounter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计时器：记录操作耗时</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer documentProcessingTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer searchTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer answerGenerationTimer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 直方图：记录数值分布</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DistributionSummary searchResultSizeSummary;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DistributionSummary contextLengthSummary;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MetricsService</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化计数器</span></span><br><span class="line">        <span class="built_in">this</span>.documentProcessedCounter = Counter.builder(<span class="string">&quot;rag_documents_processed_total&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;Total number of documents processed&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.searchRequestCounter = Counter.builder(<span class="string">&quot;rag_search_requests_total&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;Total number of search requests&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化计时器</span></span><br><span class="line">        <span class="built_in">this</span>.documentProcessingTimer = Timer.builder(<span class="string">&quot;rag_document_processing_duration&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;Document processing duration&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化直方图</span></span><br><span class="line">        <span class="built_in">this</span>.searchResultSizeSummary = DistributionSummary.builder(<span class="string">&quot;rag_search_results_size&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;Size of search results&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录文档处理指标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDocumentProcessing</span><span class="params">(<span class="type">long</span> duration, <span class="type">int</span> chunkCount)</span> &#123;</span><br><span class="line">        documentProcessedCounter.increment();</span><br><span class="line">        documentProcessingTimer.record(Duration.ofMillis(duration));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 记录分块数量</span></span><br><span class="line">        Gauge.builder(<span class="string">&quot;rag_document_chunks&quot;</span>, () -&gt; chunkCount)</span><br><span class="line">                .description(<span class="string">&quot;Number of chunks in last processed document&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录搜索指标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordSearch</span><span class="params">(<span class="type">long</span> duration, <span class="type">int</span> resultCount, <span class="type">double</span> avgScore)</span> &#123;</span><br><span class="line">        searchRequestCounter.increment();</span><br><span class="line">        searchTimer.record(Duration.ofMillis(duration));</span><br><span class="line">        searchResultSizeSummary.record(resultCount);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 记录平均相似度</span></span><br><span class="line">        Gauge.builder(<span class="string">&quot;rag_search_avg_score&quot;</span>, () -&gt; avgScore)</span><br><span class="line">                .description(<span class="string">&quot;Average similarity score of search results&quot;</span>)</span><br><span class="line">                .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-健康检查"><a href="#2-健康检查" class="headerlink" title="2. 健康检查"></a>2. 健康检查</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HealthCheckService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MilvusService milvusService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmbeddingService embeddingService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OpenAiService openAiService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 综合健康检查</span></span><br><span class="line"><span class="comment">     * 为什么需要健康检查？</span></span><br><span class="line"><span class="comment">     * 1. 故障检测：及时发现系统故障</span></span><br><span class="line"><span class="comment">     * 2. 自动恢复：触发自动恢复机制</span></span><br><span class="line"><span class="comment">     * 3. 状态监控：为运维提供系统状态</span></span><br><span class="line"><span class="comment">     * 4. 负载均衡：健康检查是负载均衡的基础</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> HealthStatus <span class="title function_">checkSystemHealth</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HealthStatus</span> <span class="variable">status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HealthStatus</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查Milvus连接</span></span><br><span class="line">        status.setMilvusHealthy(checkMilvusHealth());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查Embedding服务</span></span><br><span class="line">        status.setEmbeddingHealthy(checkEmbeddingHealth());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查OpenAI服务</span></span><br><span class="line">        status.setOpenAiHealthy(checkOpenAiHealth());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查系统资源</span></span><br><span class="line">        status.setSystemHealthy(checkSystemResources());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 总体健康状态</span></span><br><span class="line">        status.setOverallHealthy(</span><br><span class="line">            status.isMilvusHealthy() &amp;&amp; </span><br><span class="line">            status.isEmbeddingHealthy() &amp;&amp; </span><br><span class="line">            status.isOpenAiHealthy() &amp;&amp; </span><br><span class="line">            status.isSystemHealthy()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查Milvus健康状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkMilvusHealth</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行简单的集合存在性检查</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">exists</span> <span class="operator">=</span> milvusService.collectionExists();</span><br><span class="line">            <span class="keyword">return</span> exists;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Milvus健康检查失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查Embedding服务健康状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkEmbeddingHealth</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行简单的向量化测试</span></span><br><span class="line">            <span class="type">float</span>[] vector = embeddingService.embedText(<span class="string">&quot;健康检查测试&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> vector != <span class="literal">null</span> &amp;&amp; vector.length &gt; <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Embedding服务健康检查失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查系统资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkSystemResources</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检查内存使用率</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">memoryUsage</span> <span class="operator">=</span> getMemoryUsage();</span><br><span class="line">        <span class="keyword">if</span> (memoryUsage &gt; <span class="number">0.9</span>) &#123; <span class="comment">// 内存使用率超过90%</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查磁盘空间</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">diskUsage</span> <span class="operator">=</span> getDiskUsage();</span><br><span class="line">        <span class="keyword">if</span> (diskUsage &gt; <span class="number">0.9</span>) &#123; <span class="comment">// 磁盘使用率超过90%</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="最佳实践和注意事项"><a href="#最佳实践和注意事项" class="headerlink" title="最佳实践和注意事项"></a>最佳实践和注意事项</h2><h3 id="1-数据管理最佳实践"><a href="#1-数据管理最佳实践" class="headerlink" title="1. 数据管理最佳实践"></a>1. 数据管理最佳实践</h3><h4 id="文档预处理"><a href="#文档预处理" class="headerlink" title="文档预处理"></a>文档预处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocumentPreprocessingBestPractices</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文档质量评估</span></span><br><span class="line"><span class="comment">     * 为什么需要质量评估？</span></span><br><span class="line"><span class="comment">     * 1. 过滤低质量内容：避免污染知识库</span></span><br><span class="line"><span class="comment">     * 2. 提高检索准确性：高质量内容检索效果更好</span></span><br><span class="line"><span class="comment">     * 3. 节省存储和计算资源：减少无效数据处理</span></span><br><span class="line"><span class="comment">     * 4. 维护知识库纯净性：长期保持知识库质量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">assessDocumentQuality</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 检查内容长度</span></span><br><span class="line">        <span class="keyword">if</span> (content.length() &lt; <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 内容过短</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 检查内容密度</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">textDensity</span> <span class="operator">=</span> calculateTextDensity(content);</span><br><span class="line">        <span class="keyword">if</span> (textDensity &lt; <span class="number">0.3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 文本密度过低，可能包含过多格式字符</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 检查重复内容</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">uniqueness</span> <span class="operator">=</span> calculateUniqueness(content);</span><br><span class="line">        <span class="keyword">if</span> (uniqueness &lt; <span class="number">0.6</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 重复内容过多</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 检查语言质量</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isValidLanguage</span> <span class="operator">=</span> validateLanguage(content);</span><br><span class="line">        <span class="keyword">if</span> (!isValidLanguage) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 语言不符合要求</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增量更新策略</span></span><br><span class="line"><span class="comment">     * 为什么需要增量更新？</span></span><br><span class="line"><span class="comment">     * 1. 实时性：新文档可以立即被检索</span></span><br><span class="line"><span class="comment">     * 2. 效率：避免全量重建索引</span></span><br><span class="line"><span class="comment">     * 3. 可用性：更新过程中不影响现有服务</span></span><br><span class="line"><span class="comment">     * 4. 版本控制：支持文档版本管理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">incrementalUpdate</span><span class="params">(List&lt;DocumentChunk&gt; newChunks)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 标记旧版本为过期</span></span><br><span class="line">        markOldVersionsExpired(newChunks);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 插入新版本</span></span><br><span class="line">        insertNewVersions(newChunks);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 异步重建索引</span></span><br><span class="line">        scheduleIndexRebuild();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 清理过期数据</span></span><br><span class="line">        cleanupExpiredData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分块策略优化"><a href="#分块策略优化" class="headerlink" title="分块策略优化"></a>分块策略优化</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChunkingStrategy</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 智能分块算法</span></span><br><span class="line"><span class="comment">     * 为什么需要智能分块？</span></span><br><span class="line"><span class="comment">     * 1. 语义完整性：保持语义单元的完整性</span></span><br><span class="line"><span class="comment">     * 2. 检索粒度：平衡检索精度和上下文完整性</span></span><br><span class="line"><span class="comment">     * 3. 存储效率：避免过度分割造成的存储浪费</span></span><br><span class="line"><span class="comment">     * 4. 查询效率：减少需要检索的分块数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 基于语义的分块</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">semanticChunking</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 句子分割</span></span><br><span class="line">        List&lt;String&gt; sentences = splitIntoSentences(content);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 语义相似度计算</span></span><br><span class="line">        List&lt;String&gt; chunks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">currentChunk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String sentence : sentences) &#123;</span><br><span class="line">            <span class="keyword">if</span> (shouldStartNewChunk(currentChunk.toString(), sentence)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (currentChunk.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    chunks.add(currentChunk.toString());</span><br><span class="line">                    currentChunk = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            currentChunk.append(sentence).append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (currentChunk.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            chunks.add(currentChunk.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chunks;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否需要开始新分块</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">shouldStartNewChunk</span><span class="params">(String currentChunk, String nextSentence)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 长度检查</span></span><br><span class="line">        <span class="keyword">if</span> (currentChunk.length() + nextSentence.length() &gt; MAX_CHUNK_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 语义相似度检查</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">similarity</span> <span class="operator">=</span> calculateSemanticSimilarity(currentChunk, nextSentence);</span><br><span class="line">        <span class="keyword">if</span> (similarity &lt; SEMANTIC_THRESHOLD) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-性能优化建议"><a href="#2-性能优化建议" class="headerlink" title="2. 性能优化建议"></a>2. 性能优化建议</h3><h4 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryOptimizationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询预处理</span></span><br><span class="line"><span class="comment">     * 为什么需要查询预处理？</span></span><br><span class="line"><span class="comment">     * 1. 意图理解：准确理解用户查询意图</span></span><br><span class="line"><span class="comment">     * 2. 查询扩展：增加相关查询词</span></span><br><span class="line"><span class="comment">     * 3. 噪声过滤：去除无关查询词</span></span><br><span class="line"><span class="comment">     * 4. 格式标准化：统一查询格式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">preprocessQuery</span><span class="params">(String rawQuery)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 文本清理</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cleaned</span> <span class="operator">=</span> cleanText(rawQuery);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 意图识别</span></span><br><span class="line">        <span class="type">QueryIntent</span> <span class="variable">intent</span> <span class="operator">=</span> identifyIntent(cleaned);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 查询扩展</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">expanded</span> <span class="operator">=</span> expandQuery(cleaned, intent);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 权重调整</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">weighted</span> <span class="operator">=</span> adjustWeights(expanded, intent);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> weighted;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多路检索策略</span></span><br><span class="line"><span class="comment">     * 为什么需要多路检索？</span></span><br><span class="line"><span class="comment">     * 1. 提高召回率：不同策略可能召回不同文档</span></span><br><span class="line"><span class="comment">     * 2. 结果融合：综合多种检索结果</span></span><br><span class="line"><span class="comment">     * 3. 容错性：单个策略失败不影响整体结果</span></span><br><span class="line"><span class="comment">     * 4. 个性化：根据用户特点调整检索策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SearchResult&gt; <span class="title function_">multiPathRetrieval</span><span class="params">(String query, RetrievalContext context)</span> &#123;</span><br><span class="line">        List&lt;CompletableFuture&lt;List&lt;SearchResult&gt;&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 向量检索</span></span><br><span class="line">        futures.add(CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">            vectorRetrieval(query, context)));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 关键词检索</span></span><br><span class="line">        futures.add(CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">            keywordRetrieval(query, context)));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 混合检索</span></span><br><span class="line">        futures.add(CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">            hybridRetrieval(query, context)));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 等待所有检索完成</span></span><br><span class="line">        List&lt;List&lt;SearchResult&gt;&gt; allResults = futures.stream()</span><br><span class="line">            .map(CompletableFuture::join)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. 结果融合</span></span><br><span class="line">        <span class="keyword">return</span> fuseResults(allResults);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 结果融合算法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SearchResult&gt; <span class="title function_">fuseResults</span><span class="params">(List&lt;List&lt;SearchResult&gt;&gt; allResults)</span> &#123;</span><br><span class="line">        <span class="comment">// 使用RRF (Reciprocal Rank Fusion) 算法</span></span><br><span class="line">        Map&lt;String, Double&gt; scoreMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;String, SearchResult&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">60</span>; <span class="comment">// RRF常数</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (List&lt;SearchResult&gt; results : allResults) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rank</span> <span class="operator">=</span> <span class="number">0</span>; rank &lt; results.size(); rank++) &#123;</span><br><span class="line">                <span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> results.get(rank);</span><br><span class="line">                <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> result.getId();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// RRF得分计算</span></span><br><span class="line">                <span class="type">double</span> <span class="variable">rrfScore</span> <span class="operator">=</span> <span class="number">1.0</span> / (k + rank + <span class="number">1</span>);</span><br><span class="line">                scoreMap.put(id, scoreMap.getOrDefault(id, <span class="number">0.0</span>) + rrfScore);</span><br><span class="line">                </span><br><span class="line">                resultMap.put(id, result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 按融合得分排序</span></span><br><span class="line">        <span class="keyword">return</span> scoreMap.entrySet().stream()</span><br><span class="line">            .sorted(Map.Entry.&lt;String, Double&gt;comparingByValue().reversed())</span><br><span class="line">            .map(entry -&gt; &#123;</span><br><span class="line">                <span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> resultMap.get(entry.getKey());</span><br><span class="line">                result.setScore(entry.getValue());</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-安全和合规考虑"><a href="#3-安全和合规考虑" class="headerlink" title="3. 安全和合规考虑"></a>3. 安全和合规考虑</h3><h4 id="数据安全"><a href="#数据安全" class="headerlink" title="数据安全"></a>数据安全</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据加密策略</span></span><br><span class="line"><span class="comment">     * 为什么需要数据加密？</span></span><br><span class="line"><span class="comment">     * 1. 防止数据泄露：保护敏感企业信息</span></span><br><span class="line"><span class="comment">     * 2. 合规要求：满足GDPR等法规要求</span></span><br><span class="line"><span class="comment">     * 3. 访问控制：确保只有授权用户访问数据</span></span><br><span class="line"><span class="comment">     * 4. 审计追踪：记录数据访问历史</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">encryptSensitiveData</span><span class="params">(DocumentChunk chunk)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 识别敏感信息</span></span><br><span class="line">        List&lt;String&gt; sensitiveFields = identifySensitiveFields(chunk);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 加密敏感字段</span></span><br><span class="line">        <span class="keyword">for</span> (String field : sensitiveFields) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">encrypted</span> <span class="operator">=</span> encryptField(chunk.getFieldValue(field));</span><br><span class="line">            chunk.setFieldValue(field, encrypted);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 添加加密元数据</span></span><br><span class="line">        chunk.setEncryptionMetadata(buildEncryptionMetadata());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问控制</span></span><br><span class="line"><span class="comment">     * 为什么需要访问控制？</span></span><br><span class="line"><span class="comment">     * 1. 数据隔离：不同部门数据相互隔离</span></span><br><span class="line"><span class="comment">     * 2. 权限分级：不同用户有不同访问权限</span></span><br><span class="line"><span class="comment">     * 3. 审计日志：记录所有访问行为</span></span><br><span class="line"><span class="comment">     * 4. 合规要求：满足企业安全策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkAccessPermission</span><span class="params">(String userId, String resourceId, </span></span><br><span class="line"><span class="params">                                       String action)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 用户身份验证</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> authenticateUser(userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 权限检查</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasPermission</span> <span class="operator">=</span> authorizationService.checkPermission(</span><br><span class="line">            user, resourceId, action);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 审计日志</span></span><br><span class="line">        auditService.logAccess(userId, resourceId, action, hasPermission);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> hasPermission;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据脱敏</span></span><br><span class="line"><span class="comment">     * 为什么需要数据脱敏？</span></span><br><span class="line"><span class="comment">     * 1. 保护隐私：隐藏个人敏感信息</span></span><br><span class="line"><span class="comment">     * 2. 测试环境：为测试提供安全数据</span></span><br><span class="line"><span class="comment">     * 3. 第三方共享：安全地共享数据给合作伙伴</span></span><br><span class="line"><span class="comment">     * 4. 合规要求：满足数据保护法规</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">desensitizeData</span><span class="params">(String content, DesensitizeLevel level)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (level) &#123;</span><br><span class="line">            <span class="keyword">case</span> LOW:</span><br><span class="line">                <span class="keyword">return</span> maskEmails(content);</span><br><span class="line">            <span class="keyword">case</span> MEDIUM:</span><br><span class="line">                <span class="keyword">return</span> maskEmailsAndPhones(content);</span><br><span class="line">            <span class="keyword">case</span> HIGH:</span><br><span class="line">                <span class="keyword">return</span> maskAllPII(content);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> content;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="部署和运维"><a href="#部署和运维" class="headerlink" title="部署和运维"></a>部署和运维</h2><h3 id="1-生产环境部署"><a href="#1-生产环境部署" class="headerlink" title="1. 生产环境部署"></a>1. 生产环境部署</h3><h4 id="Docker-Compose部署"><a href="#Docker-Compose部署" class="headerlink" title="Docker Compose部署"></a>Docker Compose部署</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># production-docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">rag-service:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">enterprise-rag:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=prod</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MILVUS_HOST=milvus-standalone</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">OPENAI_API_KEY=$&#123;OPENAI_API_KEY&#125;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus-standalone</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config:/app/config</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">milvus-standalone:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">milvusdb/milvus:v2.3.6</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;19530:19530&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9091:9091&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">milvus_data:/var/lib/milvus</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;milvus&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;standalone&quot;</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_data:/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/prometheus:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus_data:/prometheus</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">grafana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grafana/grafana:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GF_SECURITY_ADMIN_PASSWORD=admin</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">grafana_data:/var/lib/grafana</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">milvus_data:</span></span><br><span class="line">  <span class="attr">redis_data:</span></span><br><span class="line">  <span class="attr">prometheus_data:</span></span><br><span class="line">  <span class="attr">grafana_data:</span></span><br></pre></td></tr></table></figure>

<h4 id="Kubernetes部署"><a href="#Kubernetes部署" class="headerlink" title="Kubernetes部署"></a>Kubernetes部署</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rag-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rag-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">rag-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">rag-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rag-service</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">enterprise-rag:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MILVUS_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;milvus-cluster&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;redis-cluster&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;4Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2000m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rag-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">rag-service</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></table></figure>

<h3 id="2-监控告警配置"><a href="#2-监控告警配置" class="headerlink" title="2. 监控告警配置"></a>2. 监控告警配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus.yml</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;alert_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;rag-service&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;rag-service:8080&#x27;</span>]</span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">&#x27;/actuator/prometheus&#x27;</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;milvus&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;milvus-standalone:9091&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># alert_rules.yml</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RAGAlerts</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighErrorRate</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">rate(http_requests_total&#123;status=~&quot;5..&quot;&#125;[5m])</span> <span class="string">&gt;</span> <span class="number">0.05</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High error rate detected&quot;</span></span><br><span class="line">          </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">MilvusDown</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">up&#123;job=&quot;milvus&quot;&#125;</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;Milvus service is down&quot;</span></span><br><span class="line">          </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighMemoryUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">(1</span> <span class="bullet">-</span> <span class="string">system_memory_available</span> <span class="string">/</span> <span class="string">system_memory_total)</span> <span class="string">&gt;</span> <span class="number">0.9</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High memory usage detected&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="核心价值"><a href="#核心价值" class="headerlink" title="核心价值"></a>核心价值</h3><p>通过本文详细介绍的Java+Milvus企业级RAG系统，企业可以：</p>
<ol>
<li><strong>构建智能化知识库</strong>：将企业文档转换为可对话的知识资产</li>
<li><strong>提升工作效率</strong>：员工可以快速获取准确的企业信息</li>
<li><strong>降低运营成本</strong>：减少人工客服和知识查找的时间</li>
<li><strong>保证数据安全</strong>：所有数据存储在企业内部环境</li>
<li><strong>持续学习能力</strong>：系统可以持续纳入新知识</li>
</ol>
<h3 id="技术亮点"><a href="#技术亮点" class="headerlink" title="技术亮点"></a>技术亮点</h3><h4 id="架构优势"><a href="#架构优势" class="headerlink" title="架构优势"></a>架构优势</h4><ul>
<li><strong>模块化设计</strong>：各组件独立部署，便于维护和扩展</li>
<li><strong>高可用架构</strong>：集群部署保证服务连续性</li>
<li><strong>弹性伸缩</strong>：根据负载自动调整资源</li>
<li><strong>多级缓存</strong>：优化查询性能和用户体验</li>
</ul>
<h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h4><ul>
<li><strong>智能分块</strong>：平衡语义完整性和检索效率</li>
<li><strong>多路检索</strong>：提高召回率和准确性</li>
<li><strong>增量更新</strong>：支持实时知识更新</li>
<li><strong>并发控制</strong>：保证系统稳定性和响应速度</li>
</ul>
<h4 id="安全合规"><a href="#安全合规" class="headerlink" title="安全合规"></a>安全合规</h4><ul>
<li><strong>数据加密</strong>：保护敏感企业信息</li>
<li><strong>访问控制</strong>：细粒度权限管理</li>
<li><strong>审计日志</strong>：完整的数据访问记录</li>
<li><strong>合规支持</strong>：满足企业安全标准</li>
</ul>
<h3 id="实施建议"><a href="#实施建议" class="headerlink" title="实施建议"></a>实施建议</h3><h4 id="分阶段实施"><a href="#分阶段实施" class="headerlink" title="分阶段实施"></a>分阶段实施</h4><ol>
<li><strong>原型阶段</strong>：搭建最小可用系统，验证核心功能</li>
<li><strong>扩展阶段</strong>：增加更多数据源和优化性能</li>
<li><strong>生产阶段</strong>：完善监控、备份和灾备方案</li>
<li><strong>优化阶段</strong>：持续优化用户体验和系统性能</li>
</ol>
<h4 id="成功关键因素"><a href="#成功关键因素" class="headerlink" title="成功关键因素"></a>成功关键因素</h4><ol>
<li><strong>数据质量</strong>：高质量的数据是系统成功的基础</li>
<li><strong>用户体验</strong>：简洁易用的界面和快速的响应</li>
<li><strong>持续维护</strong>：定期更新知识库和优化系统</li>
<li><strong>团队协作</strong>：跨部门协作保证系统价值最大化</li>
</ol>
<h3 id="未来展望"><a href="#未来展望" class="headerlink" title="未来展望"></a>未来展望</h3><p>随着技术的不断发展，企业级RAG系统将在以下方向继续演进：</p>
<ol>
<li><strong>多模态支持</strong>：不仅支持文本，还支持图像、音频等多种模态</li>
<li><strong>深度学习优化</strong>：使用更先进的模型提升理解和生成能力</li>
<li><strong>个性化定制</strong>：根据用户角色和偏好提供个性化服务</li>
<li><strong>自动化运维</strong>：基于AI的自动化监控和故障恢复</li>
</ol>
<p>通过精心设计的Java+Milvus企业级RAG系统，企业可以有效利用内部知识资产，提升员工工作效率，为数字化转型提供强大支撑。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://milvus.io/docs">Milvus官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://platform.openai.com/docs/guides/embeddings">OpenAI Embeddings指南</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-boot">Spring Boot官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2005.11401">RAG技术详解</a></li>
<li><a target="_blank" rel="noopener" href="https://milvus.io/blog">向量数据库最佳实践</a></li>
<li><a target="_blank" rel="noopener" href="https://www.thoughtworks.com/radar/techniques/knowledge-graphs">企业知识库架构设计</a></li>
</ol>
<hr>
<p><strong>本文代码已开源</strong>：<a target="_blank" rel="noopener" href="https://github.com/your-org/enterprise-rag">https://github.com/your-org/enterprise-rag</a></p>
<p><strong>技术交流群</strong>：扫描二维码加入企业级RAG技术交流群</p>
<p><em>最后更新时间：2025-09-03</em></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://foamtomato.github.io">Foam🍅</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://foamtomato.github.io/2025/08/03/0.5.7-Java+Milvus%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7RAG%E7%B3%BB%E7%BB%9F/">https://foamtomato.github.io/2025/08/03/0.5.7-Java+Milvus%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7RAG%E7%B3%BB%E7%BB%9F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://foamtomato.github.io" target="_blank">喵喵鱼塘</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/">大语言模型</a><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/Spring-Boot/">Spring Boot</a><a class="post-meta__tags" href="/tags/%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93/">向量数据库</a><a class="post-meta__tags" href="/tags/Milvus/">Milvus</a><a class="post-meta__tags" href="/tags/%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90/">检索增强生成</a><a class="post-meta__tags" href="/tags/%E5%90%91%E9%87%8F%E6%A3%80%E7%B4%A2/">向量检索</a><a class="post-meta__tags" href="/tags/RAG/">RAG</a><a class="post-meta__tags" href="/tags/%E4%BC%81%E4%B8%9A%E5%BA%94%E7%94%A8/">企业应用</a><a class="post-meta__tags" href="/tags/%E4%BC%81%E4%B8%9A%E7%9F%A5%E8%AF%86%E5%BA%93/">企业知识库</a></div><div class="post_share"><div class="social-share" data-image="https://images.unsplash.com/photo-1677442136019-21780ecad995?w=800&amp;h=600&amp;fit=crop" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/01/21/0.5.6-%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E6%B5%81%E4%BA%A7%E5%93%81%E5%AF%B9%E6%AF%94/" title="向量数据库搭建与主流产品对比"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1558494949-ef010cbdcc31?w=800&amp;h=600&amp;fit=crop" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">向量数据库搭建与主流产品对比</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/01/21/0.5.6-%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E6%B5%81%E4%BA%A7%E5%93%81%E5%AF%B9%E6%AF%94/" title="向量数据库搭建与主流产品对比"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1558494949-ef010cbdcc31?w=800&h=600&fit=crop" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-21</div><div class="title">向量数据库搭建与主流产品对比</div></div></a></div><div><a href="/2025/01/15/0.5.2-LangChain4j%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84LLM%E5%BA%94%E7%94%A8/" title="LangChain4j打造自己的LLM应用"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1677442136019-21780ecad995?w=800&h=600&fit=crop" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-15</div><div class="title">LangChain4j打造自己的LLM应用</div></div></a></div><div><a href="/2025/01/16/0.5.3-SpringAI%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84LLM%E5%BA%94%E7%94%A8/" title="Spring AI打造自己的LLM应用"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1555949963-aa79dcee981c?w=800&h=600&fit=crop" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-16</div><div class="title">Spring AI打造自己的LLM应用</div></div></a></div><div><a href="/2025/01/17/0.5.4-Java%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BEMCP%E5%AE%9A%E5%88%B6%E6%97%85%E6%B8%B8%E8%B7%AF%E7%BA%BF/" title="Java高德地图MCP定制旅游路线"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=800&h=600&fit=crop" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-17</div><div class="title">Java高德地图MCP定制旅游路线</div></div></a></div><div><a href="/2025/01/20/0.5.5-Java%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97MCP%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/" title="Java异常日志MCP服务架构"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&h=600&fit=crop" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-20</div><div class="title">Java异常日志MCP服务架构</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/favicon.ico" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Foam🍅</div><div class="author-info__description">用能力换时间，用时间换能力</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">57</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">68</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">工作繁忙，不会定期更新！！！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">引言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%BC%81%E4%B8%9A%E7%BA%A7RAG%E7%B3%BB%E7%BB%9F%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">为什么需要企业级RAG系统？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RAG%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.</span> <span class="toc-text">RAG技术原理详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E8%A7%A3%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">核心组件解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E7%BB%84%E4%BB%B6%EF%BC%88Document-Processing%EF%BC%89"><span class="toc-number">2.1.1.</span> <span class="toc-text">1. 文档处理组件（Document Processing）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%90%91%E9%87%8F%E6%A3%80%E7%B4%A2%E7%BB%84%E4%BB%B6%EF%BC%88Vector-Search%EF%BC%89"><span class="toc-number">2.1.2.</span> <span class="toc-text">2. 向量检索组件（Vector Search）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%94%9F%E6%88%90%E5%A2%9E%E5%BC%BA%E7%BB%84%E4%BB%B6%EF%BC%88Generation-Augmentation%EF%BC%89"><span class="toc-number">2.1.3.</span> <span class="toc-text">3. 生成增强组件（Generation Augmentation）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">技术选型分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9Milvus%EF%BC%9F"><span class="toc-number">2.2.1.</span> <span class="toc-text">为什么选择Milvus？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.</span> <span class="toc-text">系统架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">3.1.</span> <span class="toc-text">整体架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E6%A8%A1%E5%9D%97%E8%81%8C%E8%B4%A3%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">各模块职责分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E6%8E%A5%E5%85%A5%E5%B1%82"><span class="toc-number">3.2.1.</span> <span class="toc-text">1. 数据接入层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E5%B1%82"><span class="toc-number">3.2.2.</span> <span class="toc-text">2. 文档处理层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%90%91%E9%87%8F%E6%A3%80%E7%B4%A2%E5%B1%82"><span class="toc-number">3.2.3.</span> <span class="toc-text">3. 向量检索层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E7%94%9F%E6%88%90%E5%A2%9E%E5%BC%BA%E5%B1%82"><span class="toc-number">3.2.4.</span> <span class="toc-text">4. 生成增强层</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%E4%B8%8E%E9%83%A8%E7%BD%B2"><span class="toc-number">4.</span> <span class="toc-text">环境准备与部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.</span> <span class="toc-text">开发环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Java%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="toc-number">4.1.1.</span> <span class="toc-text">1. Java环境要求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%A0%B8%E5%BF%83%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.2.</span> <span class="toc-text">2. 核心依赖配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Milvus%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88"><span class="toc-number">4.2.</span> <span class="toc-text">Milvus部署方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2%EF%BC%88%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%EF%BC%89"><span class="toc-number">4.2.1.</span> <span class="toc-text">1. 单机部署（开发环境）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%EF%BC%88%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%EF%BC%89"><span class="toc-number">4.2.2.</span> <span class="toc-text">2. 集群部署（生产环境）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="toc-number">5.</span> <span class="toc-text">核心实现代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.1.</span> <span class="toc-text">1. 配置文件设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.2.</span> <span class="toc-text">2. 文档处理服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Milvus%E6%9C%8D%E5%8A%A1%E5%B0%81%E8%A3%85"><span class="toc-number">5.3.</span> <span class="toc-text">3. Milvus服务封装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.4.</span> <span class="toc-text">4. 检索增强生成服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%90%91%E9%87%8F%E5%8C%96%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.5.</span> <span class="toc-text">5. 向量化服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">6.</span> <span class="toc-text">性能优化策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="toc-number">6.1.</span> <span class="toc-text">1. 索引优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5"><span class="toc-number">6.2.</span> <span class="toc-text">2. 缓存策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-number">6.3.</span> <span class="toc-text">3. 并发控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E5%92%8C%E8%BF%90%E7%BB%B4"><span class="toc-number">7.</span> <span class="toc-text">监控和运维</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7"><span class="toc-number">7.1.</span> <span class="toc-text">1. 指标监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">7.2.</span> <span class="toc-text">2. 健康检查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%92%8C%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">8.</span> <span class="toc-text">最佳实践和注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">8.1.</span> <span class="toc-text">1. 数据管理最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-number">8.1.1.</span> <span class="toc-text">文档预处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%9D%97%E7%AD%96%E7%95%A5%E4%BC%98%E5%8C%96"><span class="toc-number">8.1.2.</span> <span class="toc-text">分块策略优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="toc-number">8.2.</span> <span class="toc-text">2. 性能优化建议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">8.2.1.</span> <span class="toc-text">查询优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%89%E5%85%A8%E5%92%8C%E5%90%88%E8%A7%84%E8%80%83%E8%99%91"><span class="toc-number">8.3.</span> <span class="toc-text">3. 安全和合规考虑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8"><span class="toc-number">8.3.1.</span> <span class="toc-text">数据安全</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%92%8C%E8%BF%90%E7%BB%B4"><span class="toc-number">9.</span> <span class="toc-text">部署和运维</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><span class="toc-number">9.1.</span> <span class="toc-text">1. 生产环境部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker-Compose%E9%83%A8%E7%BD%B2"><span class="toc-number">9.1.1.</span> <span class="toc-text">Docker Compose部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kubernetes%E9%83%A8%E7%BD%B2"><span class="toc-number">9.1.2.</span> <span class="toc-text">Kubernetes部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE"><span class="toc-number">9.2.</span> <span class="toc-text">2. 监控告警配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">10.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%B7%E5%80%BC"><span class="toc-number">10.1.</span> <span class="toc-text">核心价值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E4%BA%AE%E7%82%B9"><span class="toc-number">10.2.</span> <span class="toc-text">技术亮点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E4%BC%98%E5%8A%BF"><span class="toc-number">10.2.1.</span> <span class="toc-text">架构优势</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">10.2.2.</span> <span class="toc-text">性能优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%90%88%E8%A7%84"><span class="toc-number">10.2.3.</span> <span class="toc-text">安全合规</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%96%BD%E5%BB%BA%E8%AE%AE"><span class="toc-number">10.3.</span> <span class="toc-text">实施建议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%98%B6%E6%AE%B5%E5%AE%9E%E6%96%BD"><span class="toc-number">10.3.1.</span> <span class="toc-text">分阶段实施</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%8A%9F%E5%85%B3%E9%94%AE%E5%9B%A0%E7%B4%A0"><span class="toc-number">10.3.2.</span> <span class="toc-text">成功关键因素</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B"><span class="toc-number">10.4.</span> <span class="toc-text">未来展望</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">11.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/08/03/0.5.7-Java+Milvus%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7RAG%E7%B3%BB%E7%BB%9F/" title="Java+Milvus搭建企业级RAG系统"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1677442136019-21780ecad995?w=800&amp;h=600&amp;fit=crop" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java+Milvus搭建企业级RAG系统"/></a><div class="content"><a class="title" href="/2025/08/03/0.5.7-Java+Milvus%E6%90%AD%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7RAG%E7%B3%BB%E7%BB%9F/" title="Java+Milvus搭建企业级RAG系统">Java+Milvus搭建企业级RAG系统</a><time datetime="2025-08-03T07:56:49.000Z" title="发表于 2025-08-03 15:56:49">2025-08-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/21/0.5.6-%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E6%B5%81%E4%BA%A7%E5%93%81%E5%AF%B9%E6%AF%94/" title="向量数据库搭建与主流产品对比"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1558494949-ef010cbdcc31?w=800&amp;h=600&amp;fit=crop" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="向量数据库搭建与主流产品对比"/></a><div class="content"><a class="title" href="/2025/01/21/0.5.6-%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%BB%E6%B5%81%E4%BA%A7%E5%93%81%E5%AF%B9%E6%AF%94/" title="向量数据库搭建与主流产品对比">向量数据库搭建与主流产品对比</a><time datetime="2025-01-21T06:30:45.000Z" title="发表于 2025-01-21 14:30:45">2025-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/20/0.5.5-Java%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97MCP%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/" title="Java异常日志MCP服务架构"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&amp;h=600&amp;fit=crop" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java异常日志MCP服务架构"/></a><div class="content"><a class="title" href="/2025/01/20/0.5.5-Java%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97MCP%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/" title="Java异常日志MCP服务架构">Java异常日志MCP服务架构</a><time datetime="2025-01-20T08:45:30.000Z" title="发表于 2025-01-20 16:45:30">2025-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/17/0.5.4-Java%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BEMCP%E5%AE%9A%E5%88%B6%E6%97%85%E6%B8%B8%E8%B7%AF%E7%BA%BF/" title="Java高德地图MCP定制旅游路线"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=800&amp;h=600&amp;fit=crop" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java高德地图MCP定制旅游路线"/></a><div class="content"><a class="title" href="/2025/01/17/0.5.4-Java%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BEMCP%E5%AE%9A%E5%88%B6%E6%97%85%E6%B8%B8%E8%B7%AF%E7%BA%BF/" title="Java高德地图MCP定制旅游路线">Java高德地图MCP定制旅游路线</a><time datetime="2025-01-17T02:30:00.000Z" title="发表于 2025-01-17 10:30:00">2025-01-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/16/0.5.3-SpringAI%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84LLM%E5%BA%94%E7%94%A8/" title="Spring AI打造自己的LLM应用"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images.unsplash.com/photo-1555949963-aa79dcee981c?w=800&amp;h=600&amp;fit=crop" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring AI打造自己的LLM应用"/></a><div class="content"><a class="title" href="/2025/01/16/0.5.3-SpringAI%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84LLM%E5%BA%94%E7%94%A8/" title="Spring AI打造自己的LLM应用">Spring AI打造自己的LLM应用</a><time datetime="2025-01-16T06:30:00.000Z" title="发表于 2025-01-16 14:30:00">2025-01-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Foam🍅</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div><!-- hexo injector body_end start --><script data-pjax>function history_calendar_injector_config(){
                var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
                var item_html = '<div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div>';
                // console.log('已挂载history_calendar') // 日志已清理
                // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
            }if( document.getElementsByClassName('sticky_layout')[0] && (location.pathname ==='all'|| 'all' ==='all')){

            history_calendar_injector_config()
        } </script><script data-pjax  src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-card-history/baiduhistory/js/main.js"></script><script data-pjax>function electric_clock_injector_config(){
                var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
                var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-clock/clock/images/weather/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading" class="entered loading"></div></div></div></div></div>';
                // console.log('已挂载electric_clock') // 日志已清理
                // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
            }if( document.getElementsByClassName('sticky_layout')[0] && (location.pathname ==='all'|| 'all' ==='all')){

            electric_clock_injector_config()
        } </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax  src="/js/clock.js"></script><!-- hexo injector body_end end --></body></html>