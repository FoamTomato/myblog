name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - preview
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        default: false
        type: boolean

# è®¾ç½®æƒé™
permissions:
  contents: write
  pages: write
  id-token: write
  actions: write
  checks: write
  statuses: write

# å…è®¸å¹¶å‘è¿è¡Œï¼Œä½†å–æ¶ˆè¿›è¡Œä¸­çš„è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  HEXO_VERSION: '7.x'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: å®‰è£…Hexo CLI
        run: npm install -g hexo-cli

      - name: ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [[ ! -f "_config.yml" ]]; then
            echo "é”™è¯¯: ç¼ºå°‘ _config.yml æ–‡ä»¶"
            exit 1
          fi

          # æ£€æŸ¥å¿…è¦çš„ç›®å½•
          if [[ ! -d "source" ]]; then
            echo "é”™è¯¯: ç¼ºå°‘ source ç›®å½•"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ç« 
          article_count=$(find source/_posts -name "*.md" | wc -l)
          if [[ $article_count -eq 0 ]]; then
            echo "è­¦å‘Š: æ²¡æœ‰æ‰¾åˆ°æ–‡ç« æ–‡ä»¶"
          else
            echo "æ‰¾åˆ° $article_count ç¯‡æ–‡ç« "
          fi

      - name: æ„å»ºæµ‹è¯•
        run: |
          hexo clean
          hexo generate --silent

      - name: æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹å˜æ›´
        id: check_changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  # æ„å»ºå’Œéƒ¨ç½²
  build-and-deploy:
    name: æ„å»ºå’Œéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: quality-check
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'deploy'))

    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ç¼“å­˜Hexoä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            .deploy_git
          key: ${{ runner.os }}-hexo-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-hexo-

      - name: å®‰è£…Hexo CLI
        run: |
          if ! command -v hexo &> /dev/null; then
            npm install -g hexo-cli
          fi

      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          hexo version

      - name: é…ç½®Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "action@github.com"

      - name: æ„å»ºç«™ç‚¹
        run: |
          echo "å¼€å§‹æ„å»ºç«™ç‚¹..."
          hexo clean

          if [[ "${{ github.event.inputs.skip_tests }}" != "true" ]]; then
            hexo generate --silent
          else
            hexo generate
          fi

          # æ£€æŸ¥æ„å»ºç»“æœ
          if [[ ! -d "public" ]]; then
            echo "é”™è¯¯: æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°publicç›®å½•"
            exit 1
          fi

          # ç»Ÿè®¡æ„å»ºä¿¡æ¯
          file_count=$(find public -type f | wc -l)
          dir_size=$(du -sh public | cut -f1)
          echo "æ„å»ºå®Œæˆ: $file_count ä¸ªæ–‡ä»¶ï¼Œå¤§å°: $dir_size"

      - name: æ„å»ºæ€§èƒ½æŠ¥å‘Š
        run: |
          echo "## ğŸ“Š æ„å»ºæŠ¥å‘Š" > build-report.md
          echo "- **æ„å»ºæ—¶é—´**: $(date)" >> build-report.md
          echo "- **æ–‡ä»¶æ•°é‡**: $(find public -type f | wc -l)" >> build-report.md
          echo "- **æ„å»ºå¤§å°**: $(du -sh public | cut -f1)" >> build-report.md
          echo "- **é¡µé¢æ•°é‡**: $(find public -name "*.html" | wc -l)" >> build-report.md
          echo "- **å›¾ç‰‡æ•°é‡**: $(find public -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.gif" -o -name "*.webp" \) | wc -l)" >> build-report.md

          cat build-report.md

      - name: éƒ¨ç½²åˆ°GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          cname: ${{ secrets.CNAME || '' }}
          allow_empty_commit: false
          keep_files: false
          force_orphan: true

      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ..."
          sleep 30

          # æ£€æŸ¥GitHub PagesçŠ¶æ€
          if curl -s -I "https://api.github.com/repos/${{ github.repository }}/pages" | grep -q "200"; then
            echo "âœ… GitHub Pages éƒ¨ç½²æˆåŠŸ"
          else
            echo "âš ï¸  GitHub Pages çŠ¶æ€æ£€æŸ¥å¤±è´¥"
          fi

      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        if: always()
        run: |
          # è¿™é‡Œå¯ä»¥é›†æˆé€šçŸ¥æœåŠ¡
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          fi

  # æ€§èƒ½ç›‘æ§
  performance-check:
    name: æ€§èƒ½ç›‘æ§
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ€§èƒ½åˆ†æ
        run: |
          echo "## ğŸš€ æ€§èƒ½åˆ†ææŠ¥å‘Š" > performance-report.md

          # åˆ†ææ„å»ºäº§ç‰©
          echo "### ğŸ“¦ æ„å»ºäº§ç‰©åˆ†æ" >> performance-report.md
          echo "- **æ€»æ–‡ä»¶æ•°**: $(find public -type f | wc -l)" >> performance-report.md
          echo "- **æ€»å¤§å°**: $(du -sh public | cut -f1)" >> performance-report.md

          # åˆ†æé¡µé¢å¤§å°
          echo "### ğŸ“„ é¡µé¢å¤§å°åˆ†æ" >> performance-report.md
          find public -name "*.html" -exec wc -c {} \; | sort -nr | head -10 | while read size file; do
            echo "- $(basename "$file"): $(numfmt --to=iec-i --suffix=B $size)" >> performance-report.md
          done

          # åˆ†æå›¾ç‰‡å¤§å°
          echo "### ğŸ–¼ï¸  å›¾ç‰‡å¤§å°åˆ†æ" >> performance-report.md
          find public -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.gif" -o -name "*.webp" \) -exec wc -c {} \; | sort -nr | head -10 | while read size file; do
            echo "- $(basename "$file"): $(numfmt --to=iec-i --suffix=B $size)" >> performance-report.md
          done

          cat performance-report.md

      - name: SEOæ£€æŸ¥
        run: |
          echo "## ğŸ” SEO æ£€æŸ¥æŠ¥å‘Š" > seo-report.md

          # æ£€æŸ¥æ˜¯å¦æœ‰robots.txt
          if [[ -f "public/robots.txt" ]]; then
            echo "âœ… robots.txt å­˜åœ¨" >> seo-report.md
          else
            echo "âš ï¸  ç¼ºå°‘ robots.txt" >> seo-report.md
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰sitemap
          if [[ -f "public/sitemap.xml" ]]; then
            echo "âœ… sitemap.xml å­˜åœ¨" >> seo-report.md
          else
            echo "âš ï¸  ç¼ºå°‘ sitemap.xml" >> seo-report.md
          fi

          # æ£€æŸ¥é¡µé¢æ ‡é¢˜å’Œæè¿°
          page_count=$(find public -name "*.html" | wc -l)
          echo "- **æ€»é¡µé¢æ•°**: $page_count" >> seo-report.md

          cat seo-report.md

  # æ¸…ç†ä»»åŠ¡
  cleanup:
    name: æ¸…ç†ç¼“å­˜
    runs-on: ubuntu-latest
    if: always()
    needs: [build-and-deploy, performance-check]

    steps:
      - name: æ¸…ç†æ„å»ºç¼“å­˜
        run: |
          echo "æ¸…ç†æ„å»ºç¼“å­˜..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘

      - name: å‘é€æœ€ç»ˆæŠ¥å‘Š
        run: |
          echo "## ğŸ“‹ éƒ¨ç½²å®ŒæˆæŠ¥å‘Š" > final-report.md
          echo "- **å·¥ä½œæµ**: ${{ github.workflow }}" >> final-report.md
          echo "- **åˆ†æ”¯**: ${{ github.ref }}" >> final-report.md
          echo "- **æäº¤**: ${{ github.sha }}" >> final-report.md
          echo "- **æ—¶é—´**: $(date)" >> final-report.md
          echo "- **çŠ¶æ€**: ${{ job.status }}" >> final-report.md

          if [[ -f "build-report.md" ]]; then
            cat build-report.md >> final-report.md
          fi

          cat final-report.md

  # å›æ»šä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
  rollback:
    name: å›æ»šéƒ¨ç½²
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    needs: build-and-deploy

    steps:
      - name: å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
        run: |
          echo "å‡†å¤‡å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬..."
          # è¿™é‡Œå¯ä»¥å®ç°å›æ»šé€»è¾‘

      - name: å‘é€å‘Šè­¦é€šçŸ¥
        run: |
          echo "ğŸš¨ éƒ¨ç½²å¤±è´¥ï¼Œå‡†å¤‡å›æ»š"
          # è¿™é‡Œå¯ä»¥é›†æˆå‘Šè­¦é€šçŸ¥
