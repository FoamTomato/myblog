---
title: "Javaå¼‚å¸¸æ—¥å¿—MCPæœåŠ¡æ¶æ„"
date: "2025-01-20 16:45:30"
tags:
    - Java
    - MongoDB
    - MCP
    - å¤§æ¨¡å‹
    - å¼‚å¸¸å¤„ç†
    - æ—¥å¿—åˆ†æ
top_img: https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=1200&h=400&fit=crop
cover: https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&h=600&fit=crop
---

> åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¼‚å¸¸æ—¥å¿—ä¸ä»…æ˜¯é—®é¢˜æ’æŸ¥çš„é‡è¦çº¿ç´¢ï¼Œæ›´æ˜¯AIè¾…åŠ©è¯Šæ–­çš„å®è´µæ•°æ®æºã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•æ„å»ºå®Œæ•´çš„Javaå¼‚å¸¸æ—¥å¿—æ•è·ã€å­˜å‚¨å’ŒMCPæœåŠ¡æ¶æ„ï¼Œè®©å¤§æ¨¡å‹èƒ½å¤Ÿæ™ºèƒ½åˆ†æå’Œå¤„ç†å¼‚å¸¸ä¿¡æ¯ã€‚

## ğŸ¯ æ¶æ„æ¦‚è§ˆ

### ç³»ç»Ÿæ¶æ„å›¾
```
[Javaåº”ç”¨] â†’ [å¼‚å¸¸æ•è·] â†’ [æ—¥å¿—ç»“æ„åŒ–] â†’ [MongoDBå­˜å‚¨]
      â†“              â†“              â†“              â†“
[ä¸šåŠ¡é€»è¾‘] â†’ [AOPæ‹¦æˆª] â†’ [æ—¥å¿—æ¨¡å‹] â†’ [ç´¢å¼•ä¼˜åŒ–]
      â†“              â†“              â†“              â†“
[ç›‘æ§å‘Šè­¦] â†’ [å®æ—¶åˆ†æ] â†’ [MCPæœåŠ¡] â†’ [å¤§æ¨¡å‹è°ƒç”¨]
```

### æ ¸å¿ƒç»„ä»¶è¯´æ˜

## ğŸ“‹ æŠ€æœ¯æ ˆé€‰å‹

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **Spring Boot 2.7+**: å¾®æœåŠ¡æ¡†æ¶
- **MongoDB 5.0+**: æ–‡æ¡£å‹æ•°æ®åº“
- **Spring AOP**: å¼‚å¸¸æ‹¦æˆª
- **MCP (Model Context Protocol)**: å¤§æ¨¡å‹æœåŠ¡åè®®
- **Jackson**: JSONåºåˆ—åŒ–
- **SLF4J + Logback**: æ—¥å¿—æ¡†æ¶

### ä¾èµ–ç‰ˆæœ¬
```xml
<properties>
    <java.version>17</java.version>
    <spring-boot.version>2.7.18</spring-boot.version>
    <mongodb.version>4.11.1</mongodb.version>
    <jackson.version>2.15.3</jackson.version>
</properties>
```

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. å¼‚å¸¸æ—¥å¿—æ¨¡å‹è®¾è®¡

#### åŸºç¡€å¼‚å¸¸ä¿¡æ¯æ¨¡å‹
```java
@Data
@Document(collection = "exception_logs")
public class ExceptionLog {
    @Id
    private String id;

    // åŸºç¡€ä¿¡æ¯
    private String applicationName;
    private String serviceName;
    private String instanceId;

    // å¼‚å¸¸ä¿¡æ¯
    private String exceptionType;
    private String exceptionMessage;
    private String stackTrace;

    // ä¸šåŠ¡ä¸Šä¸‹æ–‡
    private String userId;
    private String requestId;
    private String sessionId;
    private String traceId;

    // è¯·æ±‚ä¿¡æ¯
    private String httpMethod;
    private String requestUri;
    private String clientIp;
    private Map<String, String> requestHeaders;
    private Map<String, Object> requestParams;
    private Map<String, Object> requestBody;

    // ç³»ç»Ÿä¿¡æ¯
    private String serverName;
    private String serverIp;
    private Integer serverPort;
    private String environment;

    // æ€§èƒ½ä¿¡æ¯
    private Long executionTime;
    private Long memoryUsage;
    private Integer threadCount;

    // æ—¶é—´ä¿¡æ¯
    private LocalDateTime exceptionTime;
    private LocalDateTime createTime;

    // çŠ¶æ€ä¿¡æ¯
    private ExceptionStatus status;
    private String resolution;
    private Integer occurrenceCount;

    // åˆ†ç±»ä¿¡æ¯
    private ExceptionCategory category;
    private ExceptionSeverity severity;
    private List<String> tags;

    // AIåˆ†æç»“æœ
    private String aiAnalysis;
    private List<String> suggestions;
    private String similarExceptions;
}
```

#### å¼‚å¸¸çŠ¶æ€æšä¸¾
```java
public enum ExceptionStatus {
    NEW("æ–°å¼‚å¸¸"),
    ANALYZING("åˆ†æä¸­"),
    RESOLVED("å·²è§£å†³"),
    IGNORED("å·²å¿½ç•¥"),
    RECURRING("é‡å¤å‡ºç°");

    private final String description;

    ExceptionStatus(String description) {
        this.description = description;
    }
}
```

#### å¼‚å¸¸åˆ†ç±»æšä¸¾
```java
public enum ExceptionCategory {
    BUSINESS_EXCEPTION("ä¸šåŠ¡å¼‚å¸¸"),
    SYSTEM_EXCEPTION("ç³»ç»Ÿå¼‚å¸¸"),
    NETWORK_EXCEPTION("ç½‘ç»œå¼‚å¸¸"),
    DATABASE_EXCEPTION("æ•°æ®åº“å¼‚å¸¸"),
    SECURITY_EXCEPTION("å®‰å…¨å¼‚å¸¸"),
    PERFORMANCE_EXCEPTION("æ€§èƒ½å¼‚å¸¸"),
    THIRD_PARTY_EXCEPTION("ç¬¬ä¸‰æ–¹æœåŠ¡å¼‚å¸¸"),
    UNKNOWN("æœªçŸ¥å¼‚å¸¸");
}
```

#### å¼‚å¸¸ä¸¥é‡ç¨‹åº¦æšä¸¾
```java
public enum ExceptionSeverity {
    LOW("ä½"),
    MEDIUM("ä¸­"),
    HIGH("é«˜"),
    CRITICAL("ä¸¥é‡");

    private final String description;

    ExceptionSeverity(String description) {
        this.description = description;
    }
}
```

### 2. å…¨å±€å¼‚å¸¸æ•è·å™¨

#### å…¨å±€å¼‚å¸¸å¤„ç†å™¨
```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @Autowired
    private ExceptionLogService exceptionLogService;

    @Autowired
    private RequestContextHolder requestContextHolder;

    /**
     * å¤„ç†æ‰€æœ‰æœªæ•è·çš„å¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public ResponseEntity<ErrorResponse> handleException(Exception ex, HttpServletRequest request) {
        // åˆ›å»ºå¼‚å¸¸æ—¥å¿—
        ExceptionLog exceptionLog = createExceptionLog(ex, request, ExceptionCategory.SYSTEM_EXCEPTION, ExceptionSeverity.HIGH);

        // å¼‚æ­¥ä¿å­˜å¼‚å¸¸æ—¥å¿—
        CompletableFuture.runAsync(() -> {
            try {
                exceptionLogService.saveAsync(exceptionLog);
            } catch (Exception e) {
                log.error("ä¿å­˜å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
            }
        });

        // è¿”å›é”™è¯¯å“åº”
        ErrorResponse errorResponse = ErrorResponse.builder()
                .success(false)
                .errorCode("SYSTEM_ERROR")
                .message("ç³»ç»Ÿå†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜")
                .requestId(exceptionLog.getRequestId())
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(errorResponse);
    }

    /**
     * å¤„ç†ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ErrorResponse> handleBusinessException(BusinessException ex, HttpServletRequest request) {
        ExceptionLog exceptionLog = createExceptionLog(ex, request, ExceptionCategory.BUSINESS_EXCEPTION, ex.getSeverity());

        // å¼‚æ­¥ä¿å­˜
        exceptionLogService.saveAsync(exceptionLog);

        ErrorResponse errorResponse = ErrorResponse.builder()
                .success(false)
                .errorCode(ex.getErrorCode())
                .message(ex.getMessage())
                .requestId(exceptionLog.getRequestId())
                .timestamp(LocalDateTime.now())
                .build();

        return ResponseEntity.status(ex.getHttpStatus()).body(errorResponse);
    }

    /**
     * åˆ›å»ºå¼‚å¸¸æ—¥å¿—å¯¹è±¡
     */
    private ExceptionLog createExceptionLog(Exception ex, HttpServletRequest request,
                                          ExceptionCategory category, ExceptionSeverity severity) {
        // è·å–è¯·æ±‚ä¸Šä¸‹æ–‡
        RequestContext context = requestContextHolder.getContext();

        return ExceptionLog.builder()
                .applicationName(getApplicationName())
                .serviceName(getServiceName())
                .instanceId(getInstanceId())
                .exceptionType(ex.getClass().getSimpleName())
                .exceptionMessage(ex.getMessage())
                .stackTrace(getStackTrace(ex))
                .userId(context.getUserId())
                .requestId(context.getRequestId())
                .sessionId(context.getSessionId())
                .traceId(context.getTraceId())
                .httpMethod(request.getMethod())
                .requestUri(request.getRequestURI())
                .clientIp(getClientIp(request))
                .requestHeaders(getRequestHeaders(request))
                .requestParams(getRequestParams(request))
                .requestBody(context.getRequestBody())
                .serverName(getServerName())
                .serverIp(getServerIp())
                .serverPort(request.getServerPort())
                .environment(getEnvironment())
                .executionTime(context.getExecutionTime())
                .memoryUsage(getMemoryUsage())
                .threadCount(getThreadCount())
                .exceptionTime(LocalDateTime.now())
                .createTime(LocalDateTime.now())
                .status(ExceptionStatus.NEW)
                .category(category)
                .severity(severity)
                .tags(generateTags(ex))
                .build();
    }

    // è¾…åŠ©æ–¹æ³•
    private String getStackTrace(Exception ex) {
        StringWriter sw = new StringWriter();
        PrintWriter pw = new PrintWriter(sw);
        ex.printStackTrace(pw);
        return sw.toString();
    }

    private String getClientIp(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null && !xForwardedFor.isEmpty()) {
            return xForwardedFor.split(",")[0].trim();
        }
        return request.getRemoteAddr();
    }

    private List<String> generateTags(Exception ex) {
        List<String> tags = new ArrayList<>();
        tags.add(ex.getClass().getSimpleName());

        // æ ¹æ®å¼‚å¸¸ç±»å‹æ·»åŠ æ ‡ç­¾
        if (ex instanceof SQLException) {
            tags.add("database");
            tags.add("sql");
        } else if (ex instanceof IOException) {
            tags.add("io");
            tags.add("file");
        } else if (ex instanceof TimeoutException) {
            tags.add("timeout");
            tags.add("performance");
        }

        return tags;
    }
}
```

#### ä¸šåŠ¡å¼‚å¸¸åŸºç±»
```java
@Getter
public class BusinessException extends RuntimeException {

    private final String errorCode;
    private final HttpStatus httpStatus;
    private final ExceptionSeverity severity;
    private final Map<String, Object> context;

    public BusinessException(String errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
        this.httpStatus = HttpStatus.BAD_REQUEST;
        this.severity = ExceptionSeverity.MEDIUM;
        this.context = new HashMap<>();
    }

    public BusinessException(String errorCode, String message, HttpStatus httpStatus) {
        super(message);
        this.errorCode = errorCode;
        this.httpStatus = httpStatus;
        this.severity = httpStatus.is5xxServerError() ? ExceptionSeverity.HIGH : ExceptionSeverity.MEDIUM;
        this.context = new HashMap<>();
    }

    public BusinessException(String errorCode, String message, Throwable cause) {
        super(message, cause);
        this.errorCode = errorCode;
        this.httpStatus = HttpStatus.INTERNAL_SERVER_ERROR;
        this.severity = ExceptionSeverity.HIGH;
        this.context = new HashMap<>();
    }

    public BusinessException addContext(String key, Object value) {
        this.context.put(key, value);
        return this;
    }
}
```

### 3. MongoDBå­˜å‚¨æœåŠ¡

#### MongoDBé…ç½®
```java
@Configuration
public class MongoConfig {

    @Bean
    public MongoTemplate mongoTemplate(MongoDatabaseFactory databaseFactory) {
        MappingMongoConverter converter = new MappingMongoConverter(new DefaultDbRefResolver(databaseFactory), new MongoMappingContext());
        converter.setCustomConversions(customConversions());
        converter.afterPropertiesSet();

        MongoTemplate mongoTemplate = new MongoTemplate(databaseFactory, converter);

        // åˆ›å»ºç´¢å¼•
        createIndexes(mongoTemplate);

        return mongoTemplate;
    }

    private CustomConversions customConversions() {
        List<Converter<?, ?>> converters = new ArrayList<>();
        converters.add(new LocalDateTimeToStringConverter());
        converters.add(new StringToLocalDateTimeConverter());
        return new CustomConversions(converters);
    }

    private void createIndexes(MongoTemplate mongoTemplate) {
        // å¤åˆç´¢å¼•ï¼šå¼‚å¸¸ç±»å‹ + æ—¶é—´
        mongoTemplate.indexOps(ExceptionLog.class)
                .ensureIndex(new Index()
                        .on("exceptionType", Sort.Direction.ASC)
                        .on("exceptionTime", Sort.Direction.DESC)
                        .named("exception_type_time"));

        // æ—¶é—´ç´¢å¼•
        mongoTemplate.indexOps(ExceptionLog.class)
                .ensureIndex(new Index()
                        .on("exceptionTime", Sort.Direction.DESC)
                        .expire(30 * 24 * 60 * 60) // 30å¤©åè‡ªåŠ¨åˆ é™¤
                        .named("exception_time_ttl"));

        // çŠ¶æ€ç´¢å¼•
        mongoTemplate.indexOps(ExceptionLog.class)
                .ensureIndex(new Index()
                        .on("status", Sort.Direction.ASC)
                        .named("exception_status"));

        // ç”¨æˆ·IDç´¢å¼•
        mongoTemplate.indexOps(ExceptionLog.class)
                .ensureIndex(new Index()
                        .on("userId", Sort.Direction.ASC)
                        .named("user_id"));

        // è¯·æ±‚IDç´¢å¼•
        mongoTemplate.indexOps(ExceptionLog.class)
                .ensureIndex(new Index()
                        .on("requestId", Sort.Direction.ASC)
                        .named("request_id"));
    }
}
```

#### å¼‚å¸¸æ—¥å¿—æœåŠ¡
```java
@Service
@Slf4j
public class ExceptionLogService {

    @Autowired
    private MongoTemplate mongoTemplate;

    @Autowired
    private ApplicationEventPublisher eventPublisher;

    /**
     * åŒæ­¥ä¿å­˜å¼‚å¸¸æ—¥å¿—
     */
    public ExceptionLog save(ExceptionLog exceptionLog) {
        try {
            // è®¾ç½®åˆ›å»ºæ—¶é—´
            exceptionLog.setCreateTime(LocalDateTime.now());

            // æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤å¼‚å¸¸
            checkDuplicateException(exceptionLog);

            // ä¿å­˜åˆ°MongoDB
            ExceptionLog saved = mongoTemplate.save(exceptionLog);

            // å‘å¸ƒå¼‚å¸¸äº‹ä»¶
            eventPublisher.publishEvent(new ExceptionLoggedEvent(saved));

            log.info("å¼‚å¸¸æ—¥å¿—ä¿å­˜æˆåŠŸ: {}", saved.getId());
            return saved;
        } catch (Exception e) {
            log.error("ä¿å­˜å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
            throw new RuntimeException("ä¿å­˜å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
        }
    }

    /**
     * å¼‚æ­¥ä¿å­˜å¼‚å¸¸æ—¥å¿—
     */
    @Async
    public CompletableFuture<Void> saveAsync(ExceptionLog exceptionLog) {
        return CompletableFuture.runAsync(() -> {
            try {
                save(exceptionLog);
            } catch (Exception e) {
                log.error("å¼‚æ­¥ä¿å­˜å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
            }
        });
    }

    /**
     * æ‰¹é‡ä¿å­˜å¼‚å¸¸æ—¥å¿—
     */
    public List<ExceptionLog> saveBatch(List<ExceptionLog> exceptionLogs) {
        try {
            return (List<ExceptionLog>) mongoTemplate.insertAll(exceptionLogs);
        } catch (Exception e) {
            log.error("æ‰¹é‡ä¿å­˜å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
            throw new RuntimeException("æ‰¹é‡ä¿å­˜å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
        }
    }

    /**
     * æ£€æŸ¥é‡å¤å¼‚å¸¸
     */
    private void checkDuplicateException(ExceptionLog exceptionLog) {
        // æŸ¥è¯¢æœ€è¿‘24å°æ—¶å†…ç›¸åŒç±»å‹çš„å¼‚å¸¸
        LocalDateTime startTime = LocalDateTime.now().minusHours(24);

        Query query = Query.query(Criteria.where("exceptionType").is(exceptionLog.getExceptionType())
                .and("exceptionMessage").is(exceptionLog.getExceptionMessage())
                .and("exceptionTime").gte(startTime));

        List<ExceptionLog> similarExceptions = mongoTemplate.find(query, ExceptionLog.class);

        if (!similarExceptions.isEmpty()) {
            // æ›´æ–°ç¬¬ä¸€ä¸ªå¼‚å¸¸çš„å‘ç”Ÿæ¬¡æ•°
            ExceptionLog firstException = similarExceptions.get(0);
            firstException.setOccurrenceCount(firstException.getOccurrenceCount() + 1);
            mongoTemplate.save(firstException);

            // å°†å½“å‰å¼‚å¸¸æ ‡è®°ä¸ºé‡å¤
            exceptionLog.setStatus(ExceptionStatus.RECURRING);
            exceptionLog.setSimilarExceptions(firstException.getId());
        }
    }

    /**
     * æ ¹æ®IDæŸ¥è¯¢å¼‚å¸¸æ—¥å¿—
     */
    public Optional<ExceptionLog> findById(String id) {
        try {
            return Optional.ofNullable(mongoTemplate.findById(id, ExceptionLog.class));
        } catch (Exception e) {
            log.error("æŸ¥è¯¢å¼‚å¸¸æ—¥å¿—å¤±è´¥: {}", id, e);
            return Optional.empty();
        }
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢å¼‚å¸¸æ—¥å¿—
     */
    public Page<ExceptionLog> findAll(Pageable pageable) {
        try {
            Query query = new Query().with(pageable);
            List<ExceptionLog> content = mongoTemplate.find(query, ExceptionLog.class);
            long total = mongoTemplate.count(query, ExceptionLog.class);

            return new PageImpl<>(content, pageable, total);
        } catch (Exception e) {
            log.error("åˆ†é¡µæŸ¥è¯¢å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
            return new PageImpl<>(Collections.emptyList(), pageable, 0);
        }
    }

    /**
     * æ ¹æ®æ¡ä»¶æŸ¥è¯¢å¼‚å¸¸æ—¥å¿—
     */
    public List<ExceptionLog> findByCriteria(ExceptionLogCriteria criteria) {
        try {
            Query query = buildQuery(criteria);
            return mongoTemplate.find(query, ExceptionLog.class);
        } catch (Exception e) {
            log.error("æ ¹æ®æ¡ä»¶æŸ¥è¯¢å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
            return Collections.emptyList();
        }
    }

    /**
     * æ„å»ºæŸ¥è¯¢æ¡ä»¶
     */
    private Query buildQuery(ExceptionLogCriteria criteria) {
        Query query = new Query();

        if (StringUtils.hasText(criteria.getExceptionType())) {
            query.addCriteria(Criteria.where("exceptionType").is(criteria.getExceptionType()));
        }

        if (criteria.getStatus() != null) {
            query.addCriteria(Criteria.where("status").is(criteria.getStatus()));
        }

        if (criteria.getCategory() != null) {
            query.addCriteria(Criteria.where("category").is(criteria.getCategory()));
        }

        if (criteria.getSeverity() != null) {
            query.addCriteria(Criteria.where("severity").is(criteria.getSeverity()));
        }

        if (StringUtils.hasText(criteria.getUserId())) {
            query.addCriteria(Criteria.where("userId").is(criteria.getUserId()));
        }

        if (criteria.getStartTime() != null && criteria.getEndTime() != null) {
            query.addCriteria(Criteria.where("exceptionTime")
                    .gte(criteria.getStartTime())
                    .lte(criteria.getEndTime()));
        }

        if (criteria.getTags() != null && !criteria.getTags().isEmpty()) {
            query.addCriteria(Criteria.where("tags").in(criteria.getTags()));
        }

        return query;
    }

    /**
     * æ›´æ–°å¼‚å¸¸çŠ¶æ€
     */
    public boolean updateStatus(String id, ExceptionStatus status, String resolution) {
        try {
            Query query = Query.query(Criteria.where("_id").is(new ObjectId(id)));
            Update update = new Update()
                    .set("status", status)
                    .set("resolution", resolution);

            UpdateResult result = mongoTemplate.updateFirst(query, update, ExceptionLog.class);
            return result.getModifiedCount() > 0;
        } catch (Exception e) {
            log.error("æ›´æ–°å¼‚å¸¸çŠ¶æ€å¤±è´¥: {}", id, e);
            return false;
        }
    }

    /**
     * è·å–å¼‚å¸¸ç»Ÿè®¡ä¿¡æ¯
     */
    public ExceptionStatistics getStatistics(LocalDateTime startTime, LocalDateTime endTime) {
        try {
            MatchOperation matchOperation = Aggregation.match(
                    Criteria.where("exceptionTime").gte(startTime).lte(endTime)
            );

            GroupOperation groupOperation = Aggregation.group()
                    .count().as("totalCount")
                    .addToSet("exceptionType").as("exceptionTypes")
                    .addToSet("category").as("categories")
                    .addToSet("severity").as("severities");

            Aggregation aggregation = Aggregation.newAggregation(matchOperation, groupOperation);
            AggregationResults<ExceptionStatistics> results = mongoTemplate.aggregate(aggregation, "exception_logs", ExceptionStatistics.class);

            return results.getUniqueMappedResult();
        } catch (Exception e) {
            log.error("è·å–å¼‚å¸¸ç»Ÿè®¡ä¿¡æ¯å¤±è´¥", e);
            return new ExceptionStatistics();
        }
    }
}
```

### 4. MCPæœåŠ¡æ¥å£

#### MCPæœåŠ¡é…ç½®
```java
@Configuration
@EnableMcpServer
public class McpServerConfig {

    @Bean
    public McpServerTransport mcpServerTransport() {
        return new StdioServerTransport();
    }

    @Bean
    public McpServerCapabilities serverCapabilities() {
        return McpServerCapabilities.builder()
                .tools(true)
                .resources(true)
                .prompts(true)
                .logging(true)
                .build();
    }
}
```

#### å¼‚å¸¸åˆ†æå·¥å…·
```java
@Component
@Tool
@Slf4j
public class ExceptionAnalysisTool {

    @Autowired
    private ExceptionLogService exceptionLogService;

    @Autowired
    private AiAnalysisService aiAnalysisService;

    /**
     * åˆ†æå¼‚å¸¸æ—¥å¿—
     */
    @ToolMethod(description = "åˆ†ææŒ‡å®šçš„å¼‚å¸¸æ—¥å¿—ï¼Œæä¾›è§£å†³æ–¹æ¡ˆå»ºè®®")
    public String analyzeException(
            @ToolParameter(description = "å¼‚å¸¸æ—¥å¿—ID") String exceptionId,
            @ToolParameter(description = "æ˜¯å¦éœ€è¦è¯¦ç»†åˆ†æ", required = false) Boolean detailed) {

        try {
            // æŸ¥è¯¢å¼‚å¸¸æ—¥å¿—
            Optional<ExceptionLog> exceptionLogOpt = exceptionLogService.findById(exceptionId);
            if (!exceptionLogOpt.isPresent()) {
                return "æœªæ‰¾åˆ°æŒ‡å®šçš„å¼‚å¸¸æ—¥å¿—";
            }

            ExceptionLog exceptionLog = exceptionLogOpt.get();

            // åŸºæœ¬ä¿¡æ¯åˆ†æ
            StringBuilder analysis = new StringBuilder();
            analysis.append("ğŸ” å¼‚å¸¸åˆ†ææŠ¥å‘Š\n");
            analysis.append("================\n\n");
            analysis.append(String.format("å¼‚å¸¸ç±»å‹: %s\n", exceptionLog.getExceptionType()));
            analysis.append(String.format("å¼‚å¸¸æ¶ˆæ¯: %s\n", exceptionLog.getExceptionMessage()));
            analysis.append(String.format("å‘ç”Ÿæ—¶é—´: %s\n", exceptionLog.getExceptionTime()));
            analysis.append(String.format("ä¸¥é‡ç¨‹åº¦: %s\n", exceptionLog.getSeverity()));
            analysis.append(String.format("å¼‚å¸¸åˆ†ç±»: %s\n", exceptionLog.getCategory()));
            analysis.append(String.format("æœåŠ¡åç§°: %s\n", exceptionLog.getServiceName()));
            analysis.append(String.format("è¯·æ±‚URI: %s %s\n", exceptionLog.getHttpMethod(), exceptionLog.getRequestUri()));

            if (StringUtils.hasText(exceptionLog.getUserId())) {
                analysis.append(String.format("ç”¨æˆ·ID: %s\n", exceptionLog.getUserId()));
            }

            analysis.append("\nğŸ“‹ å †æ ˆè·Ÿè¸ª:\n");
            analysis.append(exceptionLog.getStackTrace());

            // AIåˆ†æï¼ˆå¦‚æœéœ€è¦è¯¦ç»†åˆ†æï¼‰
            if (Boolean.TRUE.equals(detailed)) {
                analysis.append("\nğŸ¤– AIåˆ†æç»“æœ:\n");
                try {
                    String aiAnalysis = aiAnalysisService.analyzeException(exceptionLog);
                    analysis.append(aiAnalysis);

                    // ä¿å­˜AIåˆ†æç»“æœ
                    exceptionLog.setAiAnalysis(aiAnalysis);
                    exceptionLogService.save(exceptionLog);

                } catch (Exception e) {
                    analysis.append("AIåˆ†æå¤±è´¥: ").append(e.getMessage());
                }
            }

            return analysis.toString();

        } catch (Exception e) {
            log.error("åˆ†æå¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
            return "åˆ†æå¼‚å¸¸æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage();
        }
    }

    /**
     * æŸ¥è¯¢å¼‚å¸¸ç»Ÿè®¡
     */
    @ToolMethod(description = "æŸ¥è¯¢æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„å¼‚å¸¸ç»Ÿè®¡ä¿¡æ¯")
    public String getExceptionStatistics(
            @ToolParameter(description = "å¼€å§‹æ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ss") String startTimeStr,
            @ToolParameter(description = "ç»“æŸæ—¶é—´ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ss") String endTimeStr) {

        try {
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
            LocalDateTime startTime = LocalDateTime.parse(startTimeStr, formatter);
            LocalDateTime endTime = LocalDateTime.parse(endTimeStr, formatter);

            ExceptionStatistics statistics = exceptionLogService.getStatistics(startTime, endTime);

            StringBuilder result = new StringBuilder();
            result.append("ğŸ“Š å¼‚å¸¸ç»Ÿè®¡æŠ¥å‘Š\n");
            result.append("================\n\n");
            result.append(String.format("ç»Ÿè®¡æ—¶é—´: %s è‡³ %s\n", startTimeStr, endTimeStr));
            result.append(String.format("æ€»å¼‚å¸¸æ•°: %d\n", statistics.getTotalCount()));

            if (statistics.getExceptionTypes() != null) {
                result.append(String.format("å¼‚å¸¸ç±»å‹æ•°: %d\n", statistics.getExceptionTypes().size()));
                result.append("ä¸»è¦å¼‚å¸¸ç±»å‹:\n");
                statistics.getExceptionTypes().stream()
                        .limit(10)
                        .forEach(type -> result.append(String.format("  - %s\n", type)));
            }

            if (statistics.getCategories() != null) {
                result.append("\nå¼‚å¸¸åˆ†ç±»:\n");
                statistics.getCategories().forEach(category ->
                        result.append(String.format("  - %s\n", category)));
            }

            if (statistics.getSeverities() != null) {
                result.append("\nä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ:\n");
                statistics.getSeverities().forEach(severity ->
                        result.append(String.format("  - %s\n", severity)));
            }

            return result.toString();

        } catch (Exception e) {
            log.error("æŸ¥è¯¢å¼‚å¸¸ç»Ÿè®¡å¤±è´¥", e);
            return "æŸ¥è¯¢å¼‚å¸¸ç»Ÿè®¡æ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage();
        }
    }

    /**
     * æœç´¢ç›¸ä¼¼å¼‚å¸¸
     */
    @ToolMethod(description = "æœç´¢ä¸æŒ‡å®šå¼‚å¸¸ç›¸ä¼¼çš„å†å²å¼‚å¸¸")
    public String findSimilarExceptions(
            @ToolParameter(description = "å¼‚å¸¸ç±»å‹") String exceptionType,
            @ToolParameter(description = "å¼‚å¸¸æ¶ˆæ¯") String exceptionMessage,
            @ToolParameter(description = "æœ€å¤§è¿”å›æ•°é‡", required = false) Integer limit) {

        try {
            if (limit == null) {
                limit = 10;
            }

            // æ„å»ºæœç´¢æ¡ä»¶
            ExceptionLogCriteria criteria = ExceptionLogCriteria.builder()
                    .exceptionType(exceptionType)
                    .startTime(LocalDateTime.now().minusDays(30)) // æœ€è¿‘30å¤©
                    .endTime(LocalDateTime.now())
                    .build();

            List<ExceptionLog> similarExceptions = exceptionLogService.findByCriteria(criteria);

            StringBuilder result = new StringBuilder();
            result.append("ğŸ” ç›¸ä¼¼å¼‚å¸¸æœç´¢ç»“æœ\n");
            result.append("===================\n\n");
            result.append(String.format("æœç´¢æ¡ä»¶: %s\n", exceptionType));
            result.append(String.format("æ‰¾åˆ°å¼‚å¸¸æ•°: %d\n\n", similarExceptions.size()));

            // æ˜¾ç¤ºå‰Nä¸ªç›¸ä¼¼å¼‚å¸¸
            similarExceptions.stream()
                    .limit(limit)
                    .forEach(ex -> {
                        result.append(String.format("ID: %s\n", ex.getId()));
                        result.append(String.format("æ—¶é—´: %s\n", ex.getExceptionTime()));
                        result.append(String.format("æ¶ˆæ¯: %s\n", ex.getExceptionMessage()));
                        result.append(String.format("çŠ¶æ€: %s\n", ex.getStatus()));
                        result.append(String.format("ç”¨æˆ·: %s\n", ex.getUserId() != null ? ex.getUserId() : "æœªçŸ¥"));
                        result.append("---\n");
                    });

            return result.toString();

        } catch (Exception e) {
            log.error("æœç´¢ç›¸ä¼¼å¼‚å¸¸å¤±è´¥", e);
            return "æœç´¢ç›¸ä¼¼å¼‚å¸¸æ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage();
        }
    }

    /**
     * è·å–å¼‚å¸¸è¶‹åŠ¿åˆ†æ
     */
    @ToolMethod(description = "åˆ†æå¼‚å¸¸å‘ç”Ÿè¶‹åŠ¿å’Œæ¨¡å¼")
    public String getExceptionTrends(
            @ToolParameter(description = "åˆ†æå¤©æ•°", required = false) Integer days) {

        try {
            if (days == null) {
                days = 7;
            }

            LocalDateTime endTime = LocalDateTime.now();
            LocalDateTime startTime = endTime.minusDays(days);

            // æŒ‰å¤©ç»Ÿè®¡å¼‚å¸¸æ•°é‡
            List<ExceptionTrend> trends = getExceptionTrendsByDay(startTime, endTime);

            StringBuilder result = new StringBuilder();
            result.append("ğŸ“ˆ å¼‚å¸¸è¶‹åŠ¿åˆ†æ\n");
            result.append("===============\n\n");
            result.append(String.format("åˆ†æå‘¨æœŸ: æœ€è¿‘%då¤©\n", days));
            result.append(String.format("æ•°æ®ç‚¹æ•°: %d\n\n", trends.size()));

            result.append("æ—¥æœŸ\t\tå¼‚å¸¸æ•°é‡\tä¸»è¦ç±»å‹\n");
            result.append("----------------------------------------\n");

            for (ExceptionTrend trend : trends) {
                result.append(String.format("%s\t%d\t\t%s\n",
                        trend.getDate().toLocalDate(),
                        trend.getCount(),
                        trend.getTopExceptionType() != null ? trend.getTopExceptionType() : "æ— "));
            }

            return result.toString();

        } catch (Exception e) {
            log.error("è·å–å¼‚å¸¸è¶‹åŠ¿å¤±è´¥", e);
            return "è·å–å¼‚å¸¸è¶‹åŠ¿æ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage();
        }
    }

    private List<ExceptionTrend> getExceptionTrendsByDay(LocalDateTime startTime, LocalDateTime endTime) {
        // è¿™é‡Œå®ç°æŒ‰å¤©ç»Ÿè®¡å¼‚å¸¸æ•°é‡çš„é€»è¾‘
        // ä½¿ç”¨MongoDBèšåˆç®¡é“å®ç°
        return new ArrayList<>();
    }
}
```

#### MCPèµ„æºå¤„ç†å™¨
```java
@Component
@Resource
@Slf4j
public class ExceptionLogResource {

    @Autowired
    private ExceptionLogService exceptionLogService;

    /**
     * è·å–æœ€æ–°çš„å¼‚å¸¸æ—¥å¿—
     */
    @ResourceMethod(uri = "logs://exceptions/latest", description = "è·å–æœ€æ–°çš„å¼‚å¸¸æ—¥å¿—")
    public String getLatestExceptions(
            @ResourceParameter(description = "è·å–æ•°é‡", required = false) Integer limit) {

        try {
            if (limit == null) {
                limit = 10;
            }

            PageRequest pageRequest = PageRequest.of(0, limit, Sort.by("exceptionTime").descending());
            Page<ExceptionLog> page = exceptionLogService.findAll(pageRequest);

            StringBuilder result = new StringBuilder();
            result.append("ğŸ“‹ æœ€æ–°å¼‚å¸¸æ—¥å¿—\n");
            result.append("===============\n\n");

            for (ExceptionLog log : page.getContent()) {
                result.append(String.format("æ—¶é—´: %s\n", log.getExceptionTime()));
                result.append(String.format("ç±»å‹: %s\n", log.getExceptionType()));
                result.append(String.format("æ¶ˆæ¯: %s\n", log.getExceptionMessage()));
                result.append(String.format("ä¸¥é‡ç¨‹åº¦: %s\n", log.getSeverity()));
                result.append(String.format("çŠ¶æ€: %s\n", log.getStatus()));
                result.append("---\n");
            }

            return result.toString();

        } catch (Exception e) {
            log.error("è·å–æœ€æ–°å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
            return "è·å–æœ€æ–°å¼‚å¸¸æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage();
        }
    }

    /**
     * è·å–å¼‚å¸¸æ—¥å¿—è¯¦æƒ…
     */
    @ResourceMethod(uri = "logs://exceptions/{id}", description = "è·å–æŒ‡å®šIDçš„å¼‚å¸¸æ—¥å¿—è¯¦æƒ…")
    public String getExceptionDetails(@ResourceParameter(description = "å¼‚å¸¸æ—¥å¿—ID") String id) {

        try {
            Optional<ExceptionLog> exceptionLogOpt = exceptionLogService.findById(id);
            if (!exceptionLogOpt.isPresent()) {
                return "æœªæ‰¾åˆ°æŒ‡å®šçš„å¼‚å¸¸æ—¥å¿—";
            }

            ExceptionLog log = exceptionLogOpt.get();

            StringBuilder result = new StringBuilder();
            result.append("ğŸ“„ å¼‚å¸¸æ—¥å¿—è¯¦æƒ…\n");
            result.append("================\n\n");
            result.append(String.format("ID: %s\n", log.getId()));
            result.append(String.format("åº”ç”¨åç§°: %s\n", log.getApplicationName()));
            result.append(String.format("æœåŠ¡åç§°: %s\n", log.getServiceName()));
            result.append(String.format("å¼‚å¸¸æ—¶é—´: %s\n", log.getExceptionTime()));
            result.append(String.format("å¼‚å¸¸ç±»å‹: %s\n", log.getExceptionType()));
            result.append(String.format("å¼‚å¸¸æ¶ˆæ¯: %s\n", log.getExceptionMessage()));
            result.append(String.format("ä¸¥é‡ç¨‹åº¦: %s\n", log.getSeverity()));
            result.append(String.format("å¼‚å¸¸åˆ†ç±»: %s\n", log.getCategory()));
            result.append(String.format("çŠ¶æ€: %s\n", log.getStatus()));

            if (StringUtils.hasText(log.getResolution())) {
                result.append(String.format("è§£å†³æ–¹æ¡ˆ: %s\n", log.getResolution()));
            }

            if (log.getOccurrenceCount() > 1) {
                result.append(String.format("å‘ç”Ÿæ¬¡æ•°: %d\n", log.getOccurrenceCount()));
            }

            result.append(String.format("\nè¯·æ±‚ä¿¡æ¯:\n"));
            result.append(String.format("  æ–¹æ³•: %s\n", log.getHttpMethod()));
            result.append(String.format("  URI: %s\n", log.getRequestUri()));
            result.append(String.format("  å®¢æˆ·ç«¯IP: %s\n", log.getClientIp()));

            if (StringUtils.hasText(log.getUserId())) {
                result.append(String.format("  ç”¨æˆ·ID: %s\n", log.getUserId()));
            }

            result.append(String.format("\nå †æ ˆè·Ÿè¸ª:\n%s\n", log.getStackTrace()));

            return result.toString();

        } catch (Exception e) {
            log.error("è·å–å¼‚å¸¸æ—¥å¿—è¯¦æƒ…å¤±è´¥", e);
            return "è·å–å¼‚å¸¸æ—¥å¿—è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯: " + e.getMessage();
        }
    }
}
```

### 5. AIåˆ†ææœåŠ¡

#### AIåˆ†ææœåŠ¡æ¥å£
```java
@Service
@Slf4j
public class AiAnalysisService {

    @Autowired
    private RestTemplate restTemplate;

    @Value("${ai.analysis.endpoint:http://localhost:11434/api/generate}")
    private String aiEndpoint;

    @Value("${ai.analysis.model:llama2}")
    private String aiModel;

    /**
     * åˆ†æå¼‚å¸¸æ—¥å¿—
     */
    public String analyzeException(ExceptionLog exceptionLog) {
        try {
            // æ„å»ºåˆ†ææç¤º
            String prompt = buildAnalysisPrompt(exceptionLog);

            // è°ƒç”¨AIæ¨¡å‹
            Map<String, Object> request = new HashMap<>();
            request.put("model", aiModel);
            request.put("prompt", prompt);
            request.put("stream", false);

            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);

            HttpEntity<Map<String, Object>> entity = new HttpEntity<>(request, headers);

            ResponseEntity<Map> response = restTemplate.postForEntity(aiEndpoint, entity, Map.class);

            if (response.getStatusCode().is2xxSuccessful()) {
                Map<String, Object> responseBody = response.getBody();
                return responseBody.get("response").toString();
            } else {
                throw new RuntimeException("AIåˆ†æè¯·æ±‚å¤±è´¥: " + response.getStatusCode());
            }

        } catch (Exception e) {
            log.error("AIåˆ†æå¼‚å¸¸å¤±è´¥", e);
            return "AIåˆ†æå¤±è´¥: " + e.getMessage();
        }
    }

    /**
     * æ„å»ºåˆ†ææç¤º
     */
    private String buildAnalysisPrompt(ExceptionLog exceptionLog) {
        StringBuilder prompt = new StringBuilder();
        prompt.append("è¯·åˆ†æä»¥ä¸‹Javaå¼‚å¸¸ä¿¡æ¯ï¼Œå¹¶æä¾›è§£å†³æ–¹æ¡ˆå»ºè®®ï¼š\n\n");

        prompt.append("å¼‚å¸¸åŸºæœ¬ä¿¡æ¯ï¼š\n");
        prompt.append("- å¼‚å¸¸ç±»å‹: ").append(exceptionLog.getExceptionType()).append("\n");
        prompt.append("- å¼‚å¸¸æ¶ˆæ¯: ").append(exceptionLog.getExceptionMessage()).append("\n");
        prompt.append("- å‘ç”Ÿæ—¶é—´: ").append(exceptionLog.getExceptionTime()).append("\n");
        prompt.append("- ä¸¥é‡ç¨‹åº¦: ").append(exceptionLog.getSeverity()).append("\n");
        prompt.append("- å¼‚å¸¸åˆ†ç±»: ").append(exceptionLog.getCategory()).append("\n");

        if (StringUtils.hasText(exceptionLog.getServiceName())) {
            prompt.append("- æœåŠ¡åç§°: ").append(exceptionLog.getServiceName()).append("\n");
        }

        if (StringUtils.hasText(exceptionLog.getRequestUri())) {
            prompt.append("- è¯·æ±‚URI: ").append(exceptionLog.getRequestUri()).append("\n");
        }

        prompt.append("\nå †æ ˆè·Ÿè¸ª:\n");
        prompt.append(exceptionLog.getStackTrace());

        prompt.append("\n\nè¯·æä¾›ä»¥ä¸‹åˆ†æï¼š\n");
        prompt.append("1. å¼‚å¸¸åŸå› åˆ†æ\n");
        prompt.append("2. æ½œåœ¨å½±å“è¯„ä¼°\n");
        prompt.append("3. è§£å†³æ–¹æ¡ˆå»ºè®®\n");
        prompt.append("4. é¢„é˜²æªæ–½\n");
        prompt.append("5. ç›¸å…³ä»£ç ç¤ºä¾‹ï¼ˆå¦‚é€‚ç”¨ï¼‰\n");

        return prompt.toString();
    }

    /**
     * ç”Ÿæˆå¼‚å¸¸å¤„ç†å»ºè®®
     */
    public List<String> generateSuggestions(ExceptionLog exceptionLog) {
        List<String> suggestions = new ArrayList<>();

        // æ ¹æ®å¼‚å¸¸ç±»å‹æä¾›å»ºè®®
        switch (exceptionLog.getExceptionType()) {
            case "NullPointerException":
                suggestions.add("æ·»åŠ ç©ºå€¼æ£€æŸ¥");
                suggestions.add("ä½¿ç”¨Optionalå¤„ç†å¯èƒ½ä¸ºnullçš„å¯¹è±¡");
                suggestions.add("åœ¨æ–¹æ³•å‚æ•°ä¸­ä½¿ç”¨@NotNullæ³¨è§£");
                break;

            case "SQLException":
                suggestions.add("æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®");
                suggestions.add("éªŒè¯SQLè¯­å¥è¯­æ³•");
                suggestions.add("æ·»åŠ æ•°æ®åº“è¿æ¥æ± ç›‘æ§");
                break;

            case "IOException":
                suggestions.add("æ£€æŸ¥æ–‡ä»¶/ç½‘ç»œè¿æ¥çŠ¶æ€");
                suggestions.add("æ·»åŠ é‡è¯•æœºåˆ¶");
                suggestions.add("éªŒè¯æ–‡ä»¶æƒé™");
                break;

            case "TimeoutException":
                suggestions.add("å¢åŠ è¶…æ—¶æ—¶é—´è®¾ç½®");
                suggestions.add("ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½");
                suggestions.add("æ·»åŠ å¼‚æ­¥å¤„ç†æœºåˆ¶");
                break;

            default:
                suggestions.add("æŸ¥çœ‹è¯¦ç»†å †æ ˆè·Ÿè¸ªä¿¡æ¯");
                suggestions.add("æ£€æŸ¥ç›¸å…³æ—¥å¿—æ–‡ä»¶");
                suggestions.add("è”ç³»å¼€å‘å›¢é˜Ÿè¿›è¡Œåˆ†æ");
                break;
        }

        return suggestions;
    }
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•ç­–ç•¥
```javascript
// MongoDBç´¢å¼•é…ç½®
{
  "exception_type_time": {
    "exceptionType": 1,
    "exceptionTime": -1
  },
  "exception_time_ttl": {
    "exceptionTime": 1,
    "expireAfterSeconds": 2592000  // 30å¤©
  },
  "exception_status": {
    "status": 1
  },
  "user_id": {
    "userId": 1
  },
  "request_id": {
    "requestId": 1
  }
}
```

#### åˆ†ç‰‡ç­–ç•¥
```javascript
// MongoDBåˆ†ç‰‡é…ç½®
{
  "_id": ObjectId("..."),
  "shardKey": {
    "exceptionType": 1,
    "exceptionTime": 1
  },
  "chunks": [
    {"min": {"exceptionType": "A", "exceptionTime": ISODate("2024-01-01")},
     "max": {"exceptionType": "M", "exceptionTime": ISODate("2024-07-01")}},
    {"min": {"exceptionType": "M", "exceptionTime": ISODate("2024-07-01")},
     "max": {"exceptionType": "Z", "exceptionTime": ISODate("2025-01-01")}}
  ]
}
```

### 2. ç¼“å­˜ç­–ç•¥

#### Redisç¼“å­˜é…ç½®
```java
@Configuration
public class CacheConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);

        // è®¾ç½®åºåˆ—åŒ–å™¨
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new Jackson2JsonRedisSerializer<>(Object.class));
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(new Jackson2JsonRedisSerializer<>(Object.class));

        template.afterPropertiesSet();
        return template;
    }

    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofHours(1)) // é»˜è®¤1å°æ—¶è¿‡æœŸ
                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new Jackson2JsonRedisSerializer<>(Object.class)));

        return RedisCacheManager.builder(connectionFactory)
                .cacheDefaults(config)
                .build();
    }
}
```

#### ç¼“å­˜æœåŠ¡
```java
@Service
@Slf4j
public class ExceptionLogCacheService {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    private static final String EXCEPTION_CACHE_KEY = "exception:log:";
    private static final String STATISTICS_CACHE_KEY = "exception:statistics:";
    private static final Duration CACHE_TTL = Duration.ofMinutes(30);

    /**
     * ç¼“å­˜å¼‚å¸¸æ—¥å¿—
     */
    public void cacheExceptionLog(String id, ExceptionLog exceptionLog) {
        try {
            String key = EXCEPTION_CACHE_KEY + id;
            redisTemplate.opsForValue().set(key, exceptionLog, CACHE_TTL);
            log.debug("ç¼“å­˜å¼‚å¸¸æ—¥å¿—: {}", id);
        } catch (Exception e) {
            log.error("ç¼“å­˜å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
        }
    }

    /**
     * è·å–ç¼“å­˜çš„å¼‚å¸¸æ—¥å¿—
     */
    public ExceptionLog getCachedExceptionLog(String id) {
        try {
            String key = EXCEPTION_CACHE_KEY + id;
            return (ExceptionLog) redisTemplate.opsForValue().get(key);
        } catch (Exception e) {
            log.error("è·å–ç¼“å­˜çš„å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
            return null;
        }
    }

    /**
     * ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
     */
    public void cacheStatistics(String key, ExceptionStatistics statistics) {
        try {
            String cacheKey = STATISTICS_CACHE_KEY + key;
            redisTemplate.opsForValue().set(cacheKey, statistics, CACHE_TTL);
            log.debug("ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯: {}", key);
        } catch (Exception e) {
            log.error("ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯å¤±è´¥", e);
        }
    }

    /**
     * è·å–ç¼“å­˜çš„ç»Ÿè®¡ä¿¡æ¯
     */
    public ExceptionStatistics getCachedStatistics(String key) {
        try {
            String cacheKey = STATISTICS_CACHE_KEY + key;
            return (ExceptionStatistics) redisTemplate.opsForValue().get(cacheKey);
        } catch (Exception e) {
            log.error("è·å–ç¼“å­˜çš„ç»Ÿè®¡ä¿¡æ¯å¤±è´¥", e);
            return null;
        }
    }

    /**
     * æ¸…é™¤æ‰€æœ‰ç¼“å­˜
     */
    public void clearAllCache() {
        try {
            redisTemplate.delete(redisTemplate.keys(EXCEPTION_CACHE_KEY + "*"));
            redisTemplate.delete(redisTemplate.keys(STATISTICS_CACHE_KEY + "*"));
            log.info("æ¸…é™¤æ‰€æœ‰å¼‚å¸¸æ—¥å¿—ç¼“å­˜");
        } catch (Exception e) {
            log.error("æ¸…é™¤ç¼“å­˜å¤±è´¥", e);
        }
    }
}
```

## ğŸš€ éƒ¨ç½²æ¶æ„

### Docker Composeé…ç½®
```yaml
version: '3.8'

services:
  # Javaåº”ç”¨æœåŠ¡
  java-app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - MONGODB_URI=mongodb://mongodb:27017/exception_logs
      - REDIS_URI=redis://redis:6379
    depends_on:
      - mongodb
      - redis
    networks:
      - app-network

  # MongoDBæ•°æ®åº“
  mongodb:
    image: mongo:5.0
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=password
    networks:
      - app-network

  # Redisç¼“å­˜
  redis:
    image: redis:7.0-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network

  # MCPæœåŠ¡å™¨
  mcp-server:
    build: ./mcp-server
    ports:
      - "3000:3000"
    environment:
      - MONGODB_URI=mongodb://mongodb:27017/exception_logs
      - REDIS_URI=redis://redis:6379
    depends_on:
      - mongodb
      - redis
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
```

### Kuberneteséƒ¨ç½²
```yaml
# Javaåº”ç”¨éƒ¨ç½²
apiVersion: apps/v1
kind: Deployment
metadata:
  name: exception-log-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: exception-log-service
  template:
    metadata:
      labels:
        app: exception-log-service
    spec:
      containers:
      - name: java-app
        image: your-registry/exception-log-service:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: MONGODB_URI
          value: "mongodb://mongodb-service:27017/exception_logs"
        - name: REDIS_URI
          value: "redis://redis-service:6379"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"

---
# MongoDBéƒ¨ç½²
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
spec:
  serviceName: mongodb-service
  replicas: 1
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: mongo:5.0
        ports:
        - containerPort: 27017
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          value: "admin"
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: password
        volumeMounts:
        - name: mongodb-storage
          mountPath: /data/db
  volumeClaimTemplates:
  - metadata:
      name: mongodb-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 50Gi
```

## ğŸ“ˆ ç›‘æ§å’Œå‘Šè­¦

### ç›‘æ§æŒ‡æ ‡
```java
@Configuration
public class MetricsConfig {

    @Bean
    public MeterRegistry meterRegistry() {
        return new SimpleMeterRegistry();
    }

    @Bean
    public ExceptionLogMetrics exceptionLogMetrics(MeterRegistry meterRegistry) {
        return new ExceptionLogMetrics(meterRegistry);
    }
}

@Component
public class ExceptionLogMetrics {

    private final Counter exceptionCounter;
    private final Timer exceptionProcessingTimer;
    private final Gauge activeExceptions;

    public ExceptionLogMetrics(MeterRegistry meterRegistry) {
        this.exceptionCounter = Counter.builder("exception_log_total")
                .description("Total number of logged exceptions")
                .tags("service", "exception-log-service")
                .register(meterRegistry);

        this.exceptionProcessingTimer = Timer.builder("exception_processing_duration")
                .description("Time taken to process exception logs")
                .tags("service", "exception-log-service")
                .register(meterRegistry);

        this.activeExceptions = Gauge.builder("exception_active_total", this, ExceptionLogMetrics::getActiveExceptionCount)
                .description("Number of active (unresolved) exceptions")
                .tags("service", "exception-log-service")
                .register(meterRegistry);
    }

    public void incrementExceptionCounter(String type, String severity) {
        exceptionCounter.increment();
    }

    public Timer.Sample startProcessingTimer() {
        return Timer.start(meterRegistry);
    }

    private double getActiveExceptionCount() {
        // æŸ¥è¯¢æ´»è·ƒå¼‚å¸¸æ•°é‡çš„é€»è¾‘
        return 0.0;
    }
}
```

### å‘Šè­¦é…ç½®
```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: exception_alerts
    rules:
      - alert: HighExceptionRate
        expr: rate(exception_log_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å¼‚å¸¸å‘ç”Ÿç‡è¿‡é«˜"
          description: "è¿‡å»5åˆ†é’Ÿå¼‚å¸¸å‘ç”Ÿç‡è¶…è¿‡10æ¬¡/åˆ†é’Ÿ"

      - alert: CriticalExceptionDetected
        expr: exception_log_total{severity="CRITICAL"} > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "æ£€æµ‹åˆ°ä¸¥é‡å¼‚å¸¸"
          description: "å‘ç°ä¸¥é‡çº§åˆ«å¼‚å¸¸ï¼Œè¯·ç«‹å³å¤„ç†"

      - alert: DatabaseConnectionFailed
        expr: up{job="mongodb"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "æ•°æ®åº“è¿æ¥å¤±è´¥"
          description: "MongoDBæ•°æ®åº“è¿æ¥å¼‚å¸¸"
```

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬å¼‚å¸¸æ•è·
```java
@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    public User getUserById(String userId) {
        try {
            return userRepository.findById(userId)
                    .orElseThrow(() -> new BusinessException("USER_NOT_FOUND", "ç”¨æˆ·ä¸å­˜åœ¨: " + userId));
        } catch (DataAccessException e) {
            throw new BusinessException("DATABASE_ERROR", "æ•°æ®åº“æŸ¥è¯¢å¤±è´¥", e);
        }
    }
}
```

### 2. MCPå·¥å…·è°ƒç”¨ç¤ºä¾‹
```bash
# åˆ†æå¼‚å¸¸
mcp_tool analyze_exception exception_id="64f1a2b3c4d5e6f7g8h9i0j1" detailed=true

# æŸ¥è¯¢ç»Ÿè®¡
mcp_tool get_exception_statistics start_time="2024-01-01 00:00:00" end_time="2024-01-31 23:59:59"

# æœç´¢ç›¸ä¼¼å¼‚å¸¸
mcp_tool find_similar_exceptions exception_type="NullPointerException" limit=5

# è·å–è¶‹åŠ¿åˆ†æ
mcp_tool get_exception_trends days=7
```

### 3. èµ„æºè®¿é—®ç¤ºä¾‹
```bash
# è·å–æœ€æ–°å¼‚å¸¸
curl http://localhost:3000/logs/exceptions/latest?limit=10

# è·å–å¼‚å¸¸è¯¦æƒ…
curl http://localhost:3000/logs/exceptions/64f1a2b3c4d5e6f7g8h9i0j1
```

## ğŸ“š æ€»ç»“

æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†æ„å»ºå®Œæ•´çš„Javaå¼‚å¸¸æ—¥å¿—MCPæœåŠ¡æ¶æ„çš„å…³é”®æŠ€æœ¯ç‚¹ï¼š

### ğŸ—ï¸ æ¶æ„ä¼˜åŠ¿
- **å®Œæ•´çš„å¼‚å¸¸ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šä»æ•è·åˆ°åˆ†æåˆ°è§£å†³
- **AIé©±åŠ¨çš„æ™ºèƒ½åˆ†æ**ï¼šåˆ©ç”¨å¤§æ¨¡å‹æä¾›å¼‚å¸¸è¯Šæ–­å»ºè®®
- **é«˜æ€§èƒ½å­˜å‚¨å’ŒæŸ¥è¯¢**ï¼šMongoDB + Redisçš„ä¼˜åŒ–ç»„åˆ
- **æ ‡å‡†åŒ–æœåŠ¡æ¥å£**ï¼šMCPåè®®ä¿è¯è·¨å¹³å°å…¼å®¹æ€§

### ğŸ”§ æŠ€æœ¯äº®ç‚¹
- **å…¨å±€å¼‚å¸¸å¤„ç†**ï¼šAOP + ControllerAdviceçš„ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- **æ™ºèƒ½å¼‚å¸¸åˆ†ç±»**ï¼šåŸºäºè§„åˆ™å’ŒAIçš„å¼‚å¸¸åˆ†ç±»ç³»ç»Ÿ
- **å®æ—¶ç›‘æ§å‘Šè­¦**ï¼šPrometheus + Grafanaçš„ç›‘æ§ä½“ç³»
- **å¼¹æ€§ä¼¸ç¼©éƒ¨ç½²**ï¼šDocker + Kubernetesçš„å®¹å™¨åŒ–éƒ¨ç½²

### ğŸš€ ä¸šåŠ¡ä»·å€¼
- **æå‡é—®é¢˜è§£å†³æ•ˆç‡**ï¼šAIåˆ†æå‡å°‘æ’æŸ¥æ—¶é—´
- **é™ä½è¿ç»´æˆæœ¬**ï¼šè‡ªåŠ¨åŒ–å¼‚å¸¸å¤„ç†å’Œå‘Šè­¦
- **å¢å¼ºç³»ç»Ÿç¨³å®šæ€§**ï¼šæ•°æ®é©±åŠ¨çš„å¼‚å¸¸é¢„é˜²
- **æ”¯æŒæ•æ·å¼€å‘**ï¼šå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜

è¿™å¥—æ¶æ„ä¸ä»…è§£å†³äº†ä¼ ç»Ÿå¼‚å¸¸å¤„ç†ç³»ç»Ÿçš„ç—›ç‚¹ï¼Œè¿˜é€šè¿‡AIå’Œå¤§æ¨¡å‹çš„é›†æˆï¼Œå¼€åˆ›äº†æ™ºèƒ½å¼‚å¸¸åˆ†æçš„æ–°æ¨¡å¼ã€‚åœ¨å¾®æœåŠ¡æ¶æ„æ—¥ç›Šå¤æ‚çš„ä»Šå¤©ï¼Œè¿™ç§AIå¢å¼ºçš„å¼‚å¸¸å¤„ç†ç³»ç»Ÿå°†æˆä¸ºä¿éšœç³»ç»Ÿç¨³å®šæ€§çš„é‡è¦åŸºç¡€è®¾æ–½ã€‚

---

**ğŸ”— ç›¸å…³é“¾æ¥**
- [Spring Bootå®˜æ–¹æ–‡æ¡£](https://spring.io/projects/spring-boot)
- [MongoDBå®˜æ–¹æ–‡æ¡£](https://docs.mongodb.com/)
- [MCPåè®®è§„èŒƒ](https://modelcontextprotocol.io/)
- [Prometheusç›‘æ§](https://prometheus.io/)

---

**ğŸ¯ ç«‹å³å¼€å§‹æ„å»ºæ‚¨çš„æ™ºèƒ½å¼‚å¸¸å¤„ç†ç³»ç»Ÿï¼** ğŸš€
